function generateStudentId() {
    const students = getData('students');
    if(students.length === 0) return 1000; // start at 1000 if no students

    // Find the highest existing ID
    const maxId = students.reduce((max, s) => s.id > max ? s.id : max, 1000);

    // Next ID (max + 1), ensure it does not exceed 9999
    if(maxId >= 9999){
        alert("Maximum number of students reached (ID limit 9999).");
        return null;
    }

    return maxId + 1;
}
'Pass',comments:'Needs more flexibility.'}
        ];
        saveData('students', demoStudents);
        saveData('tests', demoTests);
        renderStudents();
        renderTests();
        renderCalendar();
    }
});

// --- Dashboard ---
function renderDashboard(){
    const students=getData('students');
    const tests=getData('tests');
    const beltCounts={White:0,Yellow:0,Green:0,Blue:0,Red:0,Black:0};
    students.forEach(s=>beltCounts[s.currentBelt]++);
    const beltCountsDiv=document.getElementById('beltCounts');
    beltCountsDiv.innerHTML='Belt Counts:<br>'+Object.entries(beltCounts).map(([b,c])=>`${b}: ${c}`).join('<br>');

    const upcomingTestsDiv=document.getElementById('upcomingTests');
    const today=new Date(); const nextMonth=new Date(); nextMonth.setMonth(today.getMonth()+1);
    const upcoming=tests.filter(t=>{ const d=new Date(t.testDate); return d>=today && d<=nextMonth; });
    upcomingTestsDiv.innerHTML=`Upcoming Tests (Next Month): ${upcoming.length}`;

    const passCount=tests.filter(t=>t.result==='Pass').length;
    const failCount=tests.filter(t=>t.result==='Fail').length;
    document.getElementById('testSummary').innerHTML=`Test Results: Pass ${passCount} | Fail ${failCount}`;
}

// --- Calendar ---
let calendarMonth=(new Date()).getMonth(), calendarYear=(new Date()).getFullYear();
document.getElementById('prevMonthBtn').addEventListener('click',()=>{
    calendarMonth--;
    if(calendarMonth<0){ calendarMonth=11; calendarYear--; }
    renderCalendar();
});
document.getElementById('nextMonthBtn').addEventListener('click',()=>{
    calendarMonth++;
    if(calendarMonth>11){ calendarMonth=0; calendarYear++; }
    renderCalendar();
});

function renderCalendar(){
    const calendarDiv=document.getElementById('calendar');
    calendarDiv.innerHTML='';
    document.getElementById('calendarMonthYear').textContent=
        `${new Date(calendarYear, calendarMonth).toLocaleString('default', { month: 'long' })} ${calendarYear}`;
    const firstDay=new Date(calendarYear, calendarMonth, 1).getDay();
    const daysInMonth=new Date(calendarYear, calendarMonth+1, 0).getDate();
    for(let i=0;i<firstDay;i++){ const emptyDiv=document.createElement('div'); calendarDiv.appendChild(emptyDiv); }
    const tests=getData('tests');
    for(let day=1; day<=daysInMonth; day++){
        const dayDiv=document.createElement('div'); dayDiv.classList.add('calendar-day');
        const dayHeader=document.createElement('h4'); dayHeader.textContent=day; dayDiv.appendChild(dayHeader);
        const dayStr=`${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dayTests=tests.filter(t=>t.testDate===dayStr);
        dayTests.forEach(t=>{
            const testEntry=document.createElement('div');
            testEntry.classList.add('test-entry'); testEntry.classList.add(`belt-${t.beltTestedFor}`);
            testEntry.textContent=`${t.studentName} (${t.beltTestedFor}) - ${t.result}`;
            testEntry.addEventListener('click',()=>{
                const newResult=prompt("Update Result (Pass/Fail):", t.result);
                if(newResult && (newResult==='Pass' || newResult==='Fail')){
                    t.result=newResult;
                    if(newResult==='Pass'){
                        const students=getData('students');
                        const student=students.find(s=>s.id===t.studentId);
                        if(student){
                            student.currentBelt=t.beltTestedFor;
                            const nextDate=new Date(t.testDate); nextDate.setMonth(nextDate.getMonth()+3);
                            student.nextTestDate=nextDate.toISOString().split('T')[0];
                            saveData('students',students);
                        }
                    }
                    saveData('tests',tests);
                    renderStudents(); renderTests(); renderCalendar(); renderDashboard();
                }
            });
            dayDiv.appendChild(testEntry);
        });
        calendarDiv.appendChild(dayDiv);
    }
}

// --- Print ---
function printSection(id){
    const content=document.getElementById(id).outerHTML;
    const w=window.open(); w.document.write('<html><head><title>Print</title></head><body>'+content+'</body></html>');
    w.document.close(); w.print();
}

// --- Initial Rendering ---
renderStudents();
renderTests();
renderCalendar();
renderDashboard();
</script>
</body>
</html>