<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taekwondo Belt Tracker</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.container { max-width: 1200px; margin: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
input, select, textarea, button { margin: 5px 0; padding: 5px; }
textarea { width: 100%; }
.dashboard { display: flex; justify-content: space-around; background-color: #eceff1; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
.dashboard div { text-align: center; font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 5px; }
.dashboard div:hover { background-color: #cfd8dc; }
.belt-White { background-color: #fff; color: #000; }
.belt-Yellow { background-color: #fff59d; color: #000; }
.belt-Green { background-color: #a5d6a7; color: #000; }
.belt-Blue { background-color: #81d4fa; color: #000; }
.belt-Red { background-color: #ef9a9a; color: #000; }
.belt-Black { background-color: #000; color: #fff; }
.next-test-soon { font-weight: bold; color: #d84315; }
#calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
.calendar-day { border: 1px solid #ccc; min-height: 80px; padding: 5px; border-radius: 5px; background-color: #f5f5f5; }
.calendar-day h4 { margin: 0 0 5px 0; font-size: 14px; text-align: center; }
.test-entry { font-size: 12px; margin: 2px 0; padding: 2px 4px; border-radius: 3px; cursor: pointer; }
.test-entry:hover { opacity: 0.8; text-decoration: underline; }
.upcoming { background-color: purple; color: white; }
@media print {
    body * { visibility: hidden; }
    .printable, .printable * { visibility: visible; }
    .printable { position: absolute; left: 0; top: 0; width: 100%; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    table, th, td { border: 1px solid black; }
    th, td { padding: 4px; text-align: left; }
    #calendar { display: block; }
    .calendar-day { border: 1px solid #000; margin-bottom: 5px; padding: 5px; page-break-inside: avoid; }
    .test-entry { font-size: 10px; padding: 2px; }
    button { display: none; }
}
</style>
</head>
<body>
<div class="container">
<h1>Taekwondo Belt Tracker</h1>

<div id="dashboard" class="dashboard">
<div id="beltCounts"></div>
<div id="upcomingTests"></div>
<div id="testSummary"></div>
</div>

<input type="text" id="searchInput" placeholder="Search by student name or belt...">

<h2>Add New Student</h2>
<form id="studentForm">
<input type="text" id="firstName" placeholder="First Name" required>
<input type="text" id="lastName" placeholder="Last Name" required>
<input type="date" id="dob" required>
<select id="currentBelt" required>
<option value="">Select Belt</option>
<option value="White">White</option>
<option value="Yellow">Yellow</option>
<option value="Green">Green</option>
<option value="Blue">Blue</option>
<option value="Red">Red</option>
<option value="Black">Black</option>
</select>
<button type="submit">Add Student</button>
</form>

<button id="exportStudentsBtn">Export Students CSV</button>
<button onclick="printSection('studentsTable')">Print Student List</button>
<button id="resetDemoBtn" style="background-color:#f44336; color:#fff;">Reset Demo Data</button>

<h2>Students</h2>
<table id="studentsTable">
<thead><tr><th>ID</th><th>Name</th><th>DOB</th><th>Current Belt</th><th>Next Eligible Test</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>

<h2>Record Belt Test</h2>
<form id="testForm">
<select id="studentSelect" required>
<option value="">Select Student</option>
</select>
<select id="beltTestedFor" required>
<option value="">Belt Tested For</option>
<option value="Yellow">Yellow</option>
<option value="Green">Green</option>
<option value="Blue">Blue</option>
<option value="Red">Red</option>
<option value="Black">Black</option>
</select>
<input type="date" id="testDate" required>
<select id="testResult" required>
<option value="">Result</option>
<option value="Pass">Pass</option>
<option value="Fail">Fail</option>
</select>
<textarea id="comments" placeholder="Comments"></textarea>
<button type="submit">Record Test</button>
</form>

<button id="exportTestsBtn">Export Tests CSV</button>
<button onclick="printSection('testsTable')">Print Test Records</button>

<h2>Belt Test Records</h2>
<table id="testsTable">
<thead><tr><th>Student</th><th>Belt Tested For</th><th>Date</th><th>Result</th><th>Comments</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>

<div id="calendarControls" style="text-align:center; margin:20px 0;">
<button id="prevMonthBtn">&lt; Previous Month</button>
<span id="calendarMonthYear" style="font-weight:bold; margin:0 15px;"></span>
<button id="nextMonthBtn">Next Month &gt;</button>
</div>
<button onclick="printSection('calendar')">Print Calendar</button>

<h2>Upcoming Tests Calendar</h2>
<div id="calendar"></div>
</div>

<script>
const beltColors={White:"#fff",Yellow:"#fff59d",Green:"#a5d6a7",Blue:"#81d4fa",Red:"#ef9a9a",Black:"#000"};

function getData(key){ return JSON.parse(localStorage.getItem(key))||[]; }
function saveData(key,data){ localStorage.setItem(key, JSON.stringify(data)); }

function generateStudentId(){
    const students=getData('students');
    if(students.length===0) return 1000;
    const maxId=students.reduce((max,s)=>s.id>max?s.id:max,1000);
    if(maxId>=9999){ alert("Max students reached."); return null; }
    return maxId+1;
}

function getNextBelt(currentBelt){
    const order=['White','Yellow','Green','Blue','Red','Black'];
    const i=order.indexOf(currentBelt);
    return i>=0 && i<order.length-1?order[i+1]:currentBelt;
}

// Demo Data
if(!localStorage.getItem('students')){
    const demoStudents=[
        {id:1000,firstName:'Ethan',lastName:'Lee',dob:'2015-04-10',currentBelt:'White',nextTestDate:'2025-09-01'},
        {id:1001,firstName:'Evelyn',lastName:'Kim',dob:'2016-07-22',currentBelt:'Yellow',nextTestDate:'2025-09-15'},
        {id:1002,firstName:'Liam',lastName:'Chen',dob:'2014-11-05',currentBelt:'Green',nextTestDate:'2025-10-05'}
    ];
    saveData('students',demoStudents);
}
if(!localStorage.getItem('tests')){
    const demoTests=[
        {studentId:1000,studentName:'Ethan Lee',beltTestedFor:'White',testDate:'2025-08-01',result:'Pass',comments:'Great start!'},
        {studentId:1001,studentName:'Evelyn Kim',beltTestedFor:'Yellow',testDate:'2025-07-15',result:'Pass',comments:'Good techniques.'},
        {studentId:1002,studentName:'Liam Chen',beltTestedFor:'Green',testDate:'2025-06-20',result:'Pass',comments:'Needs flexibility.'}
    ];
    saveData('tests',demoTests);
}

const studentForm=document.getElementById('studentForm');
const studentsTableBody=document.querySelector('#studentsTable tbody');
const studentSelect=document.getElementById('studentSelect');
const searchInput=document.getElementById('searchInput');
const testForm=document.getElementById('testForm');
const testsTableBody=document.querySelector('#testsTable tbody');
const exportStudentsBtn=document.getElementById('exportStudentsBtn');
const exportTestsBtn=document.getElementById('exportTestsBtn');
const resetDemoBtn=document.getElementById('resetDemoBtn');
let calendarMonth=(new Date()).getMonth(), calendarYear=(new Date()).getFullYear();

function renderStudents(){
    const students=getData('students');
    const filter=searchInput.value.toLowerCase();
    studentsTableBody.innerHTML='';
    studentSelect.innerHTML='<option value="">Select Student</option>';
    students.forEach(s=>{
        const name=`${s.firstName} ${s.lastName}`.toLowerCase();
        if(filter && !name.includes(filter) && !s.currentBelt.toLowerCase().includes(filter)) return;

        const row=document.createElement('tr');
        const idCell=document.createElement('td'); idCell.textContent=s.id;
        const nameCell=document.createElement('td'); nameCell.textContent=`${s.firstName} ${s.lastName}`; nameCell.contentEditable=true;
        const dobCell=document.createElement('td'); dobCell.textContent=s.dob; dobCell.contentEditable=true;
        const beltCell=document.createElement('td'); beltCell.textContent=s.currentBelt; beltCell.classList.add('belt-'+s.currentBelt); beltCell.contentEditable=true;
        const nextTestCell=document.createElement('td'); nextTestCell.textContent=s.nextTestDate||'-';

        const actionsCell=document.createElement('td');
        const saveBtn=document.createElement('button'); saveBtn.textContent='Save';
        saveBtn.addEventListener('click',()=>saveStudentEdit(s.id,nameCell,dobCell,beltCell));
        const delBtn=document.createElement('button'); delBtn.textContent='Delete'; delBtn.style.color='red';
        delBtn.addEventListener('click',()=>deleteStudent(s.id));
        actionsCell.appendChild(saveBtn); actionsCell.appendChild(delBtn);

        row.appendChild(idCell); row.appendChild(nameCell); row.appendChild(dobCell); row.appendChild(beltCell); row.appendChild(nextTestCell); row.appendChild(actionsCell);
        studentsTableBody.appendChild(row);

        const opt=document.createElement('option'); opt.value=s.id; opt.textContent=`${s.firstName} ${s.lastName}`;
        studentSelect.appendChild(opt);
    });
    renderTests(); renderDashboard(); renderCalendar();
}

function saveStudentEdit(id,nameCell,dobCell,beltCell){
    const students=getData('students'); const s=students.find(st=>st.id===id);
    if(!s) return;
    const names=nameCell.textContent.trim().split(' '); if(names.length<2){ alert('Enter full name'); renderStudents(); return;}
    const dob=dobCell.textContent.trim();
    const belt=beltCell.textContent.trim();
    const belts=['White','Yellow','Green','Blue','Red','Black'];
    if(!belts.includes(belt)){ alert('Invalid belt'); renderStudents(); return; }
    if(!/^\d{4}-\d{2}-\d{2}$/.test(dob)){ alert('Use YYYY-MM-DD'); renderStudents(); return; }
    s.firstName=names[0]; s.lastName=names.slice(1).join(' '); s.dob=dob; s.currentBelt=belt;
    saveData('students',students); renderStudents();
}

function deleteStudent(id){
    if(confirm('Delete this student?')){
        let students=getData('students'); students=students.filter(s=>s.id!==id); saveData('students',students);
        let tests=getData('tests'); tests=tests.filter(t=>t.studentId!==id); saveData('tests',tests);
        renderStudents();
    }
}

studentForm.addEventListener('submit',e=>{
    e.preventDefault(); const id=generateStudentId(); if(id===null) return;
    const students=getData('students'); 
    const newS={id,firstName:document.getElementById('firstName').value,lastName:document.getElementById('lastName').value,dob:document.getElementById('dob').value,currentBelt:document.getElementById('currentBelt').value,nextTestDate:null};
    students.push(newS); saveData('students',students); studentForm.reset(); renderStudents();
});

testForm.addEventListener('submit',e=>{
    e.preventDefault();
    const tests=getData('tests'); const students=getData('students');
    const sid=parseInt(document.getElementById('studentSelect').value); const s=students.find(st=>st.id===sid);
    if(!s) return;
    const newT={studentId:sid,studentName:`${s.firstName} ${s.lastName}`,beltTestedFor:document.getElementById('beltTestedFor').value,testDate:document.getElementById('testDate').value,result:document.getElementById('testResult').value,comments:document.getElementById('comments').value};
    if(newT.result==='Pass'){ s.currentBelt=newT.beltTestedFor; const d=new Date(newT.testDate); d.setMonth(d.getMonth()+3); s.nextTestDate=d.toISOString().split('T')[0]; saveData('students',students);}
    tests.push(newT); saveData('tests',tests); testForm.reset(); renderTests(); renderStudents();
});

// --- Render Tests ---
function renderTests(){
    const tests=getData('tests'); testsTableBody.innerHTML='';
    tests.forEach(t=>{
        const row=document.createElement('tr');
        ['studentName','beltTestedFor','testDate','result','comments'].forEach(key=>{
            const td=document.createElement('td'); td.textContent=t[key]; td.contentEditable=true; row.appendChild(td);
        });
        const act=document.createElement('td');
        const saveBtn=document.createElement('button'); saveBtn.textContent='Save';
        saveBtn.addEventListener('click',()=>saveTestEdit(t,row));
        const delBtn=document.createElement('button'); delBtn.textContent='Delete'; delBtn.style.color='red';
        delBtn.addEventListener('click',()=>deleteTest(t));
        act.appendChild(saveBtn); act.appendChild(delBtn); row.appendChild(act);
        testsTableBody.appendChild(row);
    });
}

// --- Save Test Edit ---
function saveTestEdit(test,row){
    const tests=getData('tests'); const t=tests.find(x=>x.studentId===test.studentId && x.testDate===test.testDate && x.beltTestedFor===test.beltTestedFor);
    if(!t) return;
    t.studentName=row.cells[0].textContent; t.beltTestedFor=row.cells[1].textContent;
    t.testDate=row.cells[2].textContent; t.result=row.cells[3].textContent; t.comments=row.cells[4].textContent;
    saveData('tests',tests); renderTests(); renderCalendar(); renderDashboard();
}

function deleteTest(test){
    if(confirm('Delete this test?')){
        let tests=getData('tests'); tests=tests.filter(t=>!(t.studentId===test.studentId && t.testDate===test.testDate && t.beltTestedFor===test.beltTestedFor)); saveData('tests',tests); renderTests(); renderCalendar(); renderDashboard();
    }
}

// --- Dashboard ---
function renderDashboard(){
    const students=getData('students'); const tests=getData('tests');
    const beltCounts={White:0,Yellow:0,Green:0,Blue:0,Red:0,Black:0};
    students.forEach(s=>beltCounts[s.currentBelt]++);
    const beltDiv=document.getElementById('beltCounts'); beltDiv.innerHTML=''; for(const b in beltCounts){ const d=document.createElement('div'); d.textContent=`${b}: ${beltCounts[b]}`; beltDiv.appendChild(d);}
    const upcoming=students.filter(s=>s.nextTestDate && new Date(s.nextTestDate)>=new Date());
    const upDiv=document.getElementById('upcomingTests'); upDiv.innerHTML=`Upcoming Tests: ${upcoming.length}`;
    const pass=tests.filter(t=>t.result==='Pass').length; const fail=tests.filter(t=>t.result==='Fail').length;
    document.getElementById('testSummary').textContent=`Pass: ${pass} | Fail: ${fail}`;
}

// --- Calendar ---
function renderCalendar(){
    const cal=document.getElementById('calendar'); cal.innerHTML='';
    const firstDay=new Date(calendarYear,calendarMonth,1).getDay();
    const lastDate=new Date(calendarYear,calendarMonth+1,0).getDate();
    document.getElementById('calendarMonthYear').textContent=`${calendarYear}-${calendarMonth+1}`;
    for(let i=0;i<firstDay;i++){ const d=document.createElement('div'); cal.appendChild(d);}
    const tests=getData('tests');
    for(let d=1; d<=lastDate; d++){
    const dayDiv=document.createElement('div'); dayDiv.classList.add('calendar-day');
    const dateStr = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const h4=document.createElement('h4'); h4.textContent=d; dayDiv.appendChild(h4);
    
    tests.forEach(t=>{
        if(t.testDate===dateStr){
            const entry=document.createElement('div');
            entry.classList.add('test-entry');
            if(new Date(t.testDate) > new Date()) entry.classList.add('upcoming');
            entry.textContent=`${t.studentName} - ${t.beltTestedFor} (${t.result})`;
            entry.addEventListener('click', ()=>{
                studentSelect.value = t.studentId;
                document.getElementById('beltTestedFor').value = t.beltTestedFor;
                document.getElementById('testDate').value = t.testDate;
                document.getElementById('testResult').value = t.result;
                document.getElementById('comments').value = t.comments;
            });
            dayDiv.appendChild(entry);
        }
    });

    cal.appendChild(dayDiv);
}

// --- Calendar Controls ---
document.getElementById('prevMonthBtn').onclick = ()=>{
    calendarMonth--;
    if(calendarMonth<0){ calendarMonth=11; calendarYear--; }
    renderCalendar();
};
document.getElementById('nextMonthBtn').onclick = ()=>{
    calendarMonth++;
    if(calendarMonth>11){ calendarMonth=0; calendarYear++; }
    renderCalendar();
};

// --- Search ---
searchInput.addEventListener('input', renderStudents);

// --- CSV Export ---
function exportCSV(data, filename){
    const csv=data.map(row=>Object.values(row).map(v=>`"${v}"`).join(',')).join('\n');
    const blob=new Blob([csv], {type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
exportStudentsBtn.addEventListener('click', ()=>exportCSV(getData('students'),'students.csv'));
exportTestsBtn.addEventListener('click', ()=>exportCSV(getData('tests'),'tests.csv'));

// --- Print ---
function printSection(id){
    const elem=document.getElementById(id);
    const newWin=window.open('','Print','width=900,height=600');
    newWin.document.write('<html><head><title>Print</title></head><body>'+elem.outerHTML+'</body></html>');
    newWin.document.close(); newWin.focus(); newWin.print(); newWin.close();
}

// --- Reset Demo ---
resetDemoBtn.addEventListener('click', ()=>{
    if(confirm('Reset demo data? This will erase all current data.')){
        localStorage.removeItem('students'); localStorage.removeItem('tests'); location.reload();
    }
});

// --- Initialize ---
renderStudents();
renderTests();
renderDashboard();
renderCalendar();
</script>
</body>
</html>