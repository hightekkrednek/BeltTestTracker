<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Taekwondo Student & Belt Tracker</title>
<style>
body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:0;}
section, .control-panel {
  max-width: 1000px;
  margin: 20px auto;
  padding: 20px;
  border-radius: 8px;
  box-shadow:0 0 10px rgba(0,0,0,0.05);
  background:#fff;
  overflow-x:auto;
}
table { width:100%; table-layout:auto; word-wrap:break-word; overflow-x:auto; border-collapse: collapse; }
table, th, td { border:1px solid #ccc; padding:5px; }
th { background:#eee; }
#beltCounts { display:flex; flex-wrap:wrap; gap:10px; padding:10px 0; }
.beltBadge { padding:5px 10px; border-radius:12px; color:#000; font-weight:bold; font-size:14px; min-width:60px; text-align:center;}
.belt-White{background:#ffffff; color:#000; border:1px solid #ccc;}
.belt-White-Stripe{background:#f9f9f9; color:#000; border:1px solid #ccc;}
.belt-Yellow{background:#fffacd; color:#000; border:1px solid #ccc;}
.belt-Yellow-Stripe{background:#fff8b0; color:#000; border:1px solid #ccc;}
.belt-Green{background:#90ee90; color:#000; border:1px solid #ccc;}
.belt-Green-Stripe{background:#a0f0a0; color:#000; border:1px solid #ccc;}
.belt-Blue{background:#add8e6; color:#000; border:1px solid #ccc;}
.belt-Blue-Stripe{background:#b7dfee; color:#000; border:1px solid #ccc;}
.belt-Red{background:#ff7f7f; color:#000; border:1px solid #ccc;}
.belt-Red-Stripe{background:#ff9999; color:#000; border:1px solid #ccc;}
.belt-Black{background:#333333; color:#fff; border:1px solid #000;}
#versionLabel { font-size:12px; color:#555; margin-top:10px; text-align:right; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; max-height:90%; overflow:auto; }
button { padding:5px 10px; margin:2px; }
</style>
</head>
<body>

<section>
  <h2>Dashboard</h2>
  <div id="beltCounts"></div>
</section>

<section class="control-panel">
  <h3>Control Panel</h3>
  <button onclick="openStudentModal()">Add Student</button>
  <button onclick="openBeltTestModal()">Add Belt Test</button>
  <button onclick="openInstructorModal()">Manage Instructors</button>
  <button onclick="openLocationModal()">Manage Locations</button>
  <button onclick="openBeltModal()">Manage Belts</button>
  <button onclick="importAll()">Import Data</button>
  <button onclick="exportAll()">Export Data</button>
  <button onclick="resetData()">Reset All Data</button>
  <div id="versionLabel">v1</div>
</section>

<section>
  <h3>Students</h3>
  <table id="studentTable">
    <thead><tr>
      <th>ID</th><th>Name</th><th>Birthdate</th><th>Belt</th><th>Instructors</th><th>Location</th><th>Eligible</th><th>Active</th><th>Actions</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h3>Belt Tests</h3>
  <table id="beltTestTable">
    <thead><tr>
      <th>Student</th><th>Date</th><th>Previous Belt</th><th>New Belt</th><th>Instructors</th><th>Location</th><th>Actions</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- Modals -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <h3>Add/Edit Student</h3>
    <label>Name: <input id="studentName" type="text"></label><br>
    <label>Birthdate: <input id="studentBirthdate" type="date"></label><br>
    <label>Belt: <select id="studentBelt"></select></label><br>
    <label>Instructors: <select id="studentInstructors" multiple></select></label><br>
    <label>Location: <select id="studentLocation"></select></label><br>
    <label>Eligible: <input type="checkbox" id="studentEligible"></label><br>
    <label>Active: <input type="checkbox" id="studentActive" checked></label><br>
    <button onclick="saveStudent()">Save Student</button>
    <button onclick="closeStudentModal()">Cancel</button>
  </div>
</div>

<div id="beltTestModal" class="modal">
  <div class="modal-content">
    <h3>Add Belt Test</h3>
    <label>Student: <select id="testStudent"></select></label><br>
    <label>Date: <input id="testDate" type="date"></label><br>
    <label>Previous Belt: <select id="testPrevBelt"></select></label><br>
    <label>New Belt: <select id="testNewBelt"></select></label><br>
    <label>Instructors: <select id="testInstructors" multiple></select></label><br>
    <label>Location: <select id="testLocation"></select></label><br>
    <button onclick="saveBeltTest()">Save Test</button>
    <button onclick="closeBeltTestModal()">Cancel</button>
  </div>
</div>

<div id="beltModal" class="modal">
  <div class="modal-content">
    <h3>Manage Belts</h3>
    <ul id="beltList"></ul>
    <input id="newBeltName" placeholder="New Belt Name">
    <button onclick="addBelt()">Add Belt</button>
    <button onclick="closeBeltModal()">Close</button>
  </div>
</div>

<div id="instructorModal" class="modal">
  <div class="modal-content">
    <h3>Manage Instructors</h3>
    <ul id="instructorList"></ul>
    <input id="newInstructorName" placeholder="New Instructor">
    <button onclick="addInstructor()">Add Instructor</button>
    <button onclick="closeInstructorModal()">Close</button>
  </div>
</div>

<div id="locationModal" class="modal">
  <div class="modal-content">
    <h3>Manage Locations</h3>
    <ul id="locationList"></ul>
    <input id="newLocationName" placeholder="New Location">
    <button onclick="addLocation()">Add Location</button>
    <button onclick="closeLocationModal()">Close</button>
  </div>
</div>

<script>
let students=[], beltTests=[], instructors=[], locations=[], belts=["White","White Stripe","Yellow","Yellow Stripe","Green","Green Stripe","Blue","Blue Stripe","Red","Red Stripe","Black"], nextStudentId=1000;

// Local Storage
function saveAllData(){ localStorage.setItem('tk_students',JSON.stringify(students)); localStorage.setItem('tk_tests',JSON.stringify(beltTests)); localStorage.setItem('tk_instructors',JSON.stringify(instructors)); localStorage.setItem('tk_locations',JSON.stringify(locations)); localStorage.setItem('tk_belts',JSON.stringify(belts)); localStorage.setItem('tk_nextId',nextStudentId);}
function loadAllData(){ students=JSON.parse(localStorage.getItem('tk_students')||'[]'); beltTests=JSON.parse(localStorage.getItem('tk_tests')||'[]'); instructors=JSON.parse(localStorage.getItem('tk_instructors')||'[]'); locations=JSON.parse(localStorage.getItem('tk_locations')||'[]'); belts=JSON.parse(localStorage.getItem('tk_belts')||JSON.stringify(belts)); nextStudentId=parseInt(localStorage.getItem('tk_nextId')||nextStudentId);}

// Students
function openStudentModal(){ populateStudentForm(); document.getElementById('studentModal').style.display='flex';}
function closeStudentModal(){ document.getElementById('studentModal').style.display='none';}
function populateStudentForm(){ const beltSel=document.getElementById('studentBelt'); beltSel.innerHTML=''; belts.forEach(b=>{ const opt=document.createElement('option'); opt.value=opt.innerText=b; beltSel.appendChild(opt);}); const instSel=document.getElementById('studentInstructors'); instSel.innerHTML=''; instructors.forEach(i=>{ const opt=document.createElement('option'); opt.value=opt.innerText=i; instSel.appendChild(opt);}); const locSel=document.getElementById('studentLocation'); locSel.innerHTML=''; locations.forEach(l=>{ const opt=document.createElement('option'); opt.value=opt.innerText=l; locSel.appendChild(opt);});}
function saveStudent(){
  const name=document.getElementById('studentName').value.trim();
  if(!name) { alert('Enter name'); return; }
  const student={
    id:nextStudentId++,
    name,
    birthdate:document.getElementById('studentBirthdate').value,
    belt:document.getElementById('studentBelt').value,
    instructors:Array.from(document.getElementById('studentInstructors').selectedOptions).map(o=>o.value),
    location:document.getElementById('studentLocation').value,
    eligible:document.getElementById('studentEligible').checked,
    active:document.getElementById('studentActive').checked
  };
  students.push(student);
  saveAllData(); populateTables(); closeStudentModal();
}

// Belt Tests
function openBeltTestModal(){
  const selStu=document.getElementById('testStudent'); selStu.innerHTML='';
  students.filter(s=>s.active && s.eligible).forEach(s=>{ const opt=document.createElement('option'); opt.value=s.id; opt.innerText=s.name; selStu.appendChild(opt); });
  const prev=document.getElementById('testPrevBelt'); prev.innerHTML=''; belts.forEach(b=>{ const opt=document.createElement('option'); opt.value=opt.innerText=b; prev.appendChild(opt);});
  const next=document.getElementById('testNewBelt'); next.innerHTML=''; belts.forEach(b=>{ const opt=document.createElement('option'); opt.value=opt.innerText=b; next.appendChild(opt);});
  const instSel=document.getElementById('testInstructors'); instSel.innerHTML=''; instructors.forEach(i=>{ const opt=document.createElement('option'); opt.value=i; opt.innerText=i; instSel.appendChild(opt);});
  const locSel=document.getElementById('testLocation'); locSel.innerHTML=''; locations.forEach(l=>{ const opt=document.createElement('option'); opt.value=l; opt.innerText=l; locSel.appendChild(opt);});
  document.getElementById('beltTestModal').style.display='flex';
}
function closeBeltTestModal(){ document.getElementById('beltTestModal').style.display='none';}
function saveBeltTest(){
  const studentId=parseInt(document.getElementById('testStudent').value);
  const prevB=document.getElementById('testPrevBelt').value;
  const newB=document.getElementById('testNewBelt').value;
  const test={studentId,date:document.getElementById('testDate').value,prevBelt:prevB,newBelt:newB,instructors:Array.from(document.getElementById('testInstructors').selectedOptions).map(o=>o.value),location:document.getElementById('testLocation').value};
  beltTests.push(test);
  // Update student belt automatically
  const stu=students.find(s=>s.id===studentId); if(stu) stu.belt=newB;
  saveAllData(); populateTables(); closeBeltTestModal();
}

// Populate tables
function populateTables(){
  updateBeltCounts();
  const tbody=document.querySelector('#studentTable tbody'); tbody.innerHTML='';
  students.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.id}</td><td>${s.name}</td><td>${s.birthdate}</td><td>${s.belt}</td><td>${s.instructors.join(', ')}</td><td>${s.location}</td><td><input type="checkbox" disabled ${s.eligible?'checked':''}></td><td><input type="checkbox" disabled ${s.active?'checked':''}></td><td><button onclick="editStudent(${s.id})">Edit</button></td>`;
    tbody.appendChild(tr);
  });
  const tbt=document.querySelector('#beltTestTable tbody'); tbt.innerHTML='';
  beltTests.forEach(bt=>{
    const stu=students.find(s=>s.id===bt.studentId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${stu?stu.name:''}</td><td>${bt.date}</td><td>${bt.prevBelt}</td><td>${bt.newBelt}</td><td>${bt.instructors.join(', ')}</td><td>${bt.location}</td><td></td>`;
    tbt.appendChild(tr);
  });
}

// Update dashboard
function updateBeltCounts(){
  const beltDiv=document.getElementById('beltCounts'); beltDiv.innerHTML='';
  if(students.length===0){ beltDiv.innerText="No students yet."; return; }
  let counts={};
  students.forEach(s=>{ counts[s.belt]=(counts[s.belt]||0)+1; });
  Object.entries(counts).forEach(([belt,count])=>{
    const span=document.createElement('span');
    span.className='beltBadge belt-'+belt.replace(/\s/g,'-');
    span.innerText=`${belt}: ${count}`;
    beltDiv.appendChild(span);
  });
}

// Belts
function openBeltModal(){ const ul=document.getElementById('beltList'); ul.innerHTML=''; belts.forEach((b,i)=>{ const li=document.createElement('li'); li.innerHTML=`${b} <button onclick="moveBeltUp(${i})">Up</button><button onclick="moveBeltDown(${i})">Down</button><button onclick="deleteBelt(${i})">X</button>`; ul.appendChild(li);}); document.getElementById('beltModal').style.display='flex';}
function closeBeltModal(){ document.getElementById('beltModal').style.display='none'; saveAllData(); populateTables();}
function addBelt(){ const val=document.getElementById('newBeltName').value.trim(); if(val){ belts.push(val); document.getElementById('newBeltName').value=''; openBeltModal();}}
function moveBeltUp(i){ if(i>0){ [belts[i],belts[i-1]]=[belts[i-1],belts[i]]; openBeltModal(); }}
function moveBeltDown(i){ if(i<belts.length-1){ [belts[i],belts[i+1]]=[belts[i+1],belts[i]]; openBeltModal(); }}
function deleteBelt(i){ if(confirm('Delete this belt?')){ belts.splice(i,1); openBeltModal(); }}

// Instructors
function openInstructorModal(){ const ul=document.getElementById('instructorList'); ul.innerHTML=''; instructors.forEach((i,idx)=>{ const li=document.createElement('li'); li.innerHTML=`${i} <button onclick="editInstructor(${idx})">Edit</button><button onclick="deleteInstructor(${idx})">X</button>`; ul.appendChild(li);}); document.getElementById('instructorModal').style.display='flex';}
function closeInstructorModal(){ document.getElementById('instructorModal').style.display='none'; saveAllData(); populateTables();}
function addInstructor(){ const val=document.getElementById('newInstructorName').value.trim(); if(val){instructors.push(val); document.getElementById('newInstructorName').value=''; openInstructorModal();}}
function editInstructor(idx){ const val=prompt('Edit instructor', instructors[idx]); if(val) { instructors[idx]=val; openInstructorModal(); } }
function deleteInstructor(idx){ if(confirm('Delete this instructor?')){ instructors.splice(idx,1); openInstructorModal(); } }

// Locations
function openLocationModal(){ const ul=document.getElementById('locationList'); ul.innerHTML=''; locations.forEach((l,idx)=>{ const li=document.createElement('li'); li.innerHTML=`${l} <button onclick="editLocation(${idx})">Edit</button><button onclick="deleteLocation(${idx})">X</button>`; ul.appendChild(li);}); document.getElementById('locationModal').style.display='flex';}
function closeLocationModal(){ document.getElementById('locationModal').style.display='none'; saveAllData(); populateTables();}
function addLocation(){ const val=document.getElementById('newLocationName').value.trim(); if(val){locations.push(val); document.getElementById('newLocationName').value=''; openLocationModal();}}
function editLocation(idx){ const val=prompt('Edit location', locations[idx]); if(val) { locations[idx]=val; openLocationModal(); } }
function deleteLocation(idx){ if(confirm('Delete this location?')){ locations.splice(idx,1); openLocationModal(); } }

// Import/Export
function exportAll() {
  const allData = { students, beltTests, instructors, locations, belts };
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'taekwondo_data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Import function (smart merge, you said you added manually, so link here)
function importAll() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const importedData = JSON.parse(event.target.result);
        if (!importedData) return;

        // ---- STUDENTS ----
        if (importedData.students) {
          importedData.students.forEach(iStu => {
            const existing = students.find(s => s.id === iStu.id);
            if (existing) {
              const diffs = [];
              ['name', 'birthdate', 'belt', 'instructors', 'location', 'eligible', 'active'].forEach(key => {
                if (JSON.stringify(existing[key]) !== JSON.stringify(iStu[key])) {
                  diffs.push(`${key}: current="${JSON.stringify(existing[key])}", imported="${JSON.stringify(iStu[key])}"`);
                }
              });
              if (diffs.length > 0) {
                if (confirm(`Student ID ${iStu.id} has differences:\n${diffs.join('\n')}\nOverwrite with imported values?`)) {
                  Object.assign(existing, iStu);
                }
              }
            } else {
              students.push(iStu);
              if (iStu.id >= nextStudentId) nextStudentId = iStu.id + 1;
            }
          });
        }

        // ---- BELT TESTS ----
        if (importedData.beltTests) {
          importedData.beltTests.forEach(iTest => {
            const exists = beltTests.find(bt => JSON.stringify(bt) === JSON.stringify(iTest));
            if (!exists) beltTests.push(iTest);
          });
        }

        // ---- INSTRUCTORS ----
        if (importedData.instructors) {
          importedData.instructors.forEach(i => {
            if (!instructors.includes(i)) instructors.push(i);
          });
        }

        // ---- LOCATIONS ----
        if (importedData.locations) {
          importedData.locations.forEach(l => {
            if (!locations.includes(l)) locations.push(l);
          });
        }

        // ---- BELTS ----
        if (importedData.belts) {
          importedData.belts.forEach(b => {
            if (!belts.includes(b)) belts.push(b);
          });
        }

        saveAllData();
        populateTables();
        alert('Import complete.');
      } catch (err) {
        alert('Error importing JSON: ' + err);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Reset
function resetData() {
  if (confirm('Are you sure you want to reset all data?')) {
    localStorage.clear();
    students = [];
    beltTests = [];
    instructors = [];
    locations = [];
    belts = ["White","White Stripe","Yellow","Yellow Stripe","Green","Green Stripe","Blue","Blue Stripe","Red","Red Stripe","Black"];
    nextStudentId = 1000;
    populateTables();
  }
}

// Initialize
loadAllData();
populateTables();
</script>

</body>
</html>