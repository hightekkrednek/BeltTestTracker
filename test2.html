<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Taekwondo Belt Tracking</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f7f7f8; }
  .container { max-width: 1100px; margin: auto; background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  h1 { margin: 0 0 12px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  button { padding:8px 12px; border-radius:6px; border:0; background:#1565c0; color:#fff; cursor:pointer; }
  button.secondary { background:#fff; color:#222; border:1px solid #ddd; }
  button.danger { background:#d32f2f; }
  table { width:100%; border-collapse:collapse; margin-bottom:14px; }
  th,td { border:1px solid #e6e6e6; padding:8px; text-align:left; vertical-align:top; }
  th { background:#fafafa; }
  input[type="text"], input[type="date"], select, textarea { padding:8px; border:1px solid #ddd; border-radius:6px; }
  .row6 { display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; margin-bottom:8px; align-items:center; }
  .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:9999; }
  .modal.open { display:flex; }
  .modal-card { background:#fff; width:min(880px,94vw); max-height:86vh; overflow:auto; border-radius:10px; padding:14px; box-shadow:0 16px 40px rgba(0,0,0,0.25); }
  .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .diff-table { width:100%; border-collapse:collapse; margin:6px 0; }
  .diff-table th,.diff-table td{ border-top:1px solid #eee; padding:8px; vertical-align:top; }
  .diff { background:#fffef3; }
  .note { color:#666; font-size:13px; margin-top:8px; }
  .danger-small { background:#d32f2f; color:#fff; border:none; padding:6px 10px; border-radius:6px; }
  .muted { color:#666; font-size:13px; }
  @media print {
    body * { visibility:hidden; }
    .printable, .printable * { visibility:visible; }
    .printable { position:absolute; left:0; top:0; width:100%; }
    button { display:none; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Taekwondo Belt Tracker</h1>

    <div class="controls">
      <input id="searchInput" type="text" placeholder="Search students or belts..." style="padding:8px; min-width:260px;">
      <button id="importStudentsBtn" class="secondary">Import Students (JSON)</button>
      <input id="importStudentsFile" type="file" accept=".json,application/json" style="display:none;">
      <button id="exportStudentsBtn" class="secondary">Export Students JSON</button>

      <button id="importTestsBtn" class="secondary">Import Tests (JSON)</button>
      <input id="importTestsFile" type="file" accept=".json,application/json" style="display:none;">
      <button id="exportTestsBtn" class="secondary">Export Tests JSON</button>

      <button id="importAllBtn" class="secondary">Import All (backup.json)</button>
      <input id="importAllFile" type="file" accept=".json,application/json" style="display:none;">
      <button id="exportAllBtn" class="secondary">Export All (backup.json)</button>

      <button id="printStudentsBtn" class="secondary">Print Students</button>
      <button id="printTestsBtn" class="secondary">Print Tests</button>
      <button id="resetDemoBtn" class="danger">Reset Demo</button>
    </div>

    <h2>Add New Student</h2>
    <div class="row6">
      <input id="firstName" placeholder="First name">
      <input id="lastName" placeholder="Last name">
      <input id="dob" type="date">
      <select id="currentBelt"><option value="">Belt</option><option>White</option><option>Yellow</option><option>Green</option><option>Blue</option><option>Red</option><option>Black</option></select>
      <div></div>
      <button id="addStudentBtn">Add Student</button>
    </div>

    <div class="printable">
      <h2>Students</h2>
      <table id="studentsTable">
        <thead>
          <tr><th>ID</th><th>Name</th><th>DOB</th><th>Current Belt</th><th>Eligible?</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Record Belt Test</h2>
    <div class="row6">
      <select id="studentTestSelect"><option value="">Select Student</option></select>
      <select id="beltTestedFor"><option value="">Belt Tested For</option><option>Yellow</option><option>Green</option><option>Blue</option><option>Red</option><option>Black</option></select>
      <input id="testDate" type="date">
      <select id="testResult"><option value="">Result</option><option>Pass</option><option>Fail</option></select>
      <select id="testInstructors" multiple size="4" title="Ctrl/Cmd+click to select multiple"></select>
      <select id="testLocations" multiple size="4" title="Ctrl/Cmd+click to select multiple"></select>
    </div>
    <textarea id="comments" rows="2" placeholder="Comments (optional)" style="width:100%; margin-top:8px;"></textarea>
    <div style="margin-top:8px;">
      <button id="addTestBtn">Record Test</button>
    </div>

    <div class="printable">
      <h2>Belt Test Records</h2>
      <table id="testsTable">
        <thead>
          <tr><th>Test ID</th><th>Student</th><th>Belt</th><th>Date</th><th>Result</th><th>Instructors</th><th>Locations</th><th>Comments</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Merge conflict modal -->
  <div id="mergeModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="mergeTitle">Resolve Conflict</h3>
        <button class="secondary" onclick="closeModal('mergeModal')">Close</button>
      </div>
      <div id="mergeContent"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="mergePrevBtn" class="secondary">Prev</button>
        <button id="mergeApplyBtn">Apply & Next</button>
        <button id="mergeSkipBtn" class="secondary">Skip</button>
      </div>
      <div class="note">Pick per-field whether to keep local (Current) or imported values.</div>
    </div>
  </div>

  <!-- Deletion modal -->
  <div id="deleteModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="deleteTitle">Local-only Records Found</h3>
        <button class="secondary" onclick="closeModal('deleteModal')">Close</button>
      </div>
      <div id="deleteContent"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="deleteConfirmBtn" class="danger">Delete Selected</button>
        <button id="deleteCancelBtn" class="secondary">Keep All</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Storage helpers ---------- */
const getData = key => JSON.parse(localStorage.getItem(key) || '[]');
const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

/* ---------- ID helpers ---------- */
function generateStudentId(){
  const students = getData('students');
  if(students.length === 0) return 1000;
  const maxId = students.reduce((m,s)=> s.id > m ? s.id : m, 1000);
  if(maxId >= 9999){ alert('Max students reached (9999).'); return null; }
  return maxId + 1;
}
const generateTestId = () => 't' + Date.now().toString(36) + Math.random().toString(36).slice(2,7);

/* ---------- normalize ---------- */
function normalizeEligible(v){
  if(typeof v === 'boolean') return v;
  if(typeof v === 'string'){
    const s = v.trim().toLowerCase();
    return (s === '✔' || s === 'yes' || s === 'true' || s === '1' || s === 'y' || s === 'on');
  }
  return !!v;
}

/* ---------- seed demo ---------- */
(function seed(){
  if(!localStorage.getItem('students')){
    saveData('students', [
      {id:1000, firstName:'Ethan', lastName:'Lee', dob:'2015-04-10', currentBelt:'White', eligible:true},
      {id:1001, firstName:'Evelyn', lastName:'Kim', dob:'2016-07-22', currentBelt:'Yellow', eligible:true},
      {id:1002, firstName:'Liam', lastName:'Chen', dob:'2014-11-05', currentBelt:'Green', eligible:true}
    ]);
  } else {
    // normalize any old values
    const s = getData('students').map(x=> ({ ...x, eligible: normalizeEligible(x.eligible) }));
    saveData('students', s);
  }
  if(!localStorage.getItem('tests')){
    saveData('tests', [
      {id: generateTestId(), studentId:1000, studentName:'Ethan Lee', beltTestedFor:'White', testDate:'2025-08-01', result:'Pass', comments:'Great start!', instructors:[], locations:[]},
      {id: generateTestId(), studentId:1001, studentName:'Evelyn Kim', beltTestedFor:'Yellow', testDate:'2025-07-15', result:'Pass', comments:'Good techniques.', instructors:[], locations:[]}
    ]);
  } else {
    // ensure tests have ids
    const t = getData('tests').map(x=> x.id ? x : ({ ...x, id: generateTestId() }));
    saveData('tests', t);
  }
})();

/* ---------- DOM references ---------- */
const studentsTBody = document.querySelector('#studentsTable tbody');
const testsTBody = document.querySelector('#testsTable tbody');
const studentTestSelect = document.getElementById('studentTestSelect');
const testInstructors = document.getElementById('testInstructors');
const testLocations = document.getElementById('testLocations');

const importStudentsFile = document.getElementById('importStudentsFile');
const importTestsFile = document.getElementById('importTestsFile');
const importAllFile = document.getElementById('importAllFile');

const mergeModal = document.getElementById('mergeModal');
const mergeTitle = document.getElementById('mergeTitle');
const mergeContent = document.getElementById('mergeContent');
const mergePrevBtn = document.getElementById('mergePrevBtn');
const mergeApplyBtn = document.getElementById('mergeApplyBtn');
const mergeSkipBtn = document.getElementById('mergeSkipBtn');

const deleteModal = document.getElementById('deleteModal');
const deleteTitle = document.getElementById('deleteTitle');
const deleteContent = document.getElementById('deleteContent');
const deleteConfirmBtn = document.getElementById('deleteConfirmBtn');
const deleteCancelBtn = document.getElementById('deleteCancelBtn');

let mergeQueue = []; // queue of {type:'student'|'test', local, incoming}
let mergeIndex = 0;
let pendingDeletions = []; // array of {type, id, label}

/* ---------- renderers ---------- */
function renderStudents(){
  const students = getData('students');
  const filter = (document.getElementById('searchInput').value||'').toLowerCase();
  studentsTBody.innerHTML = '';
  studentTestSelect.innerHTML = '<option value="">Select Student</option>';
  students.forEach(s=>{
    const fullName = `${s.firstName||''} ${s.lastName||''}`.trim();
    if(filter && !fullName.toLowerCase().includes(filter) && !(s.currentBelt||'').toLowerCase().includes(filter)) return;

    const tr = document.createElement('tr');
    const idCell = document.createElement('td'); idCell.textContent = s.id;
    const nameCell = document.createElement('td'); nameCell.contentEditable = true; nameCell.textContent = fullName;
    const dobCell = document.createElement('td'); dobCell.contentEditable = true; dobCell.textContent = s.dob || '';
    const beltCell = document.createElement('td'); beltCell.contentEditable = true; beltCell.textContent = s.currentBelt || '';
    const eligCell = document.createElement('td');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!normalizeEligible(s.eligible);
    cb.onchange = ()=>{ const arr = getData('students'); const st = arr.find(x=>x.id===s.id); if(st){ st.eligible = cb.checked; saveData('students', arr); } };
    eligCell.appendChild(cb);
    const actCell = document.createElement('td');
    const saveBtn = document.createElement('button'); saveBtn.textContent='Save';
    saveBtn.onclick = ()=> saveStudentInline(s.id, nameCell, dobCell, beltCell, cb);
    const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger';
    delBtn.onclick = ()=> { if(confirm('Delete this student and their tests?')) deleteStudent(s.id); };
    actCell.append(saveBtn, ' ', delBtn);

    tr.append(idCell, nameCell, dobCell, beltCell, eligCell, actCell);
    studentsTBody.appendChild(tr);

    const opt = document.createElement('option'); opt.value = s.id; opt.textContent = fullName; studentTestSelect.appendChild(opt);
  });
}

function renderTests(){
  const tests = getData('tests');
  testsTBody.innerHTML = '';
  tests.forEach(t=>{
    const tr = document.createElement('tr');
    const tdId = document.createElement('td'); tdId.textContent = t.id;
    const tdStudent = document.createElement('td'); tdStudent.contentEditable=true; tdStudent.textContent = t.studentName || '';
    const tdBelt = document.createElement('td'); tdBelt.contentEditable=true; tdBelt.textContent = t.beltTestedFor || '';
    const tdDate = document.createElement('td'); tdDate.contentEditable=true; tdDate.textContent = t.testDate || '';
    const tdResult = document.createElement('td'); tdResult.contentEditable=true; tdResult.textContent = t.result || '';
    const tdInstr = document.createElement('td'); tdInstr.contentEditable=true; tdInstr.textContent = (t.instructors||[]).join(', ');
    const tdLoc = document.createElement('td'); tdLoc.contentEditable=true; tdLoc.textContent = (t.locations||[]).join(', ');
    const tdCmt = document.createElement('td'); tdCmt.contentEditable=true; tdCmt.textContent = t.comments || '';
    const tdAct = document.createElement('td');
    const saveBtn = document.createElement('button'); saveBtn.textContent='Save';
    saveBtn.onclick = ()=> saveTestInline(t.id, tdStudent, tdBelt, tdDate, tdResult, tdInstr, tdLoc, tdCmt);
    const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger';
    delBtn.onclick = ()=> { if(confirm('Delete this test record?')) deleteTest(t.id); };
    tdAct.append(saveBtn, ' ', delBtn);

    tr.append(tdId, tdStudent, tdBelt, tdDate, tdResult, tdInstr, tdLoc, tdCmt, tdAct);
    testsTBody.appendChild(tr);
  });
}

/* ---------- student/test CRUD ---------- */
function saveStudentInline(id, nameCell, dobCell, beltCell, eligCheckbox){
  const arr = getData('students'); const s = arr.find(x=>x.id===id); if(!s) return;
  const names = nameCell.textContent.trim().split(/\s+/);
  if(names.length < 2){ alert('Please enter full name (first and last).'); renderStudents(); return; }
  const belts = ['White','Yellow','Green','Blue','Red','Black'];
  const belt = beltCell.textContent.trim();
  if(!belts.includes(belt)){ alert('Invalid belt. Use: White, Yellow, Green, Blue, Red, Black'); renderStudents(); return; }
  s.firstName = names[0];
  s.lastName = names.slice(1).join(' ');
  s.dob = dobCell.textContent.trim();
  s.currentBelt = belt;
  s.eligible = !!eligCheckbox.checked;
  saveData('students', arr);
  renderStudents();
}

function deleteStudent(id){
  let s = getData('students').filter(x=>x.id!==id); saveData('students', s);
  let t = getData('tests').filter(x=>x.studentId!==id); saveData('tests', t);
  renderStudents(); renderTests();
}

function saveTestInline(id, tdStudent, tdBelt, tdDate, tdResult, tdInstr, tdLoc, tdCmt){
  const arr = getData('tests'); const idx = arr.findIndex(x=>x.id===id); if(idx<0) return;
  arr[idx].studentName = tdStudent.textContent.trim();
  arr[idx].beltTestedFor = tdBelt.textContent.trim();
  arr[idx].testDate = tdDate.textContent.trim();
  arr[idx].result = tdResult.textContent.trim();
  arr[idx].instructors = tdInstr.textContent.split(',').map(s=>s.trim()).filter(Boolean);
  arr[idx].locations = tdLoc.textContent.split(',').map(s=>s.trim()).filter(Boolean);
  arr[idx].comments = tdCmt.textContent.trim();
  saveData('tests', arr);
  renderTests();
}

function deleteTest(id){
  let t = getData('tests').filter(x=>x.id!==id); saveData('tests', t); renderTests();
}

/* ---------- add student/test UI ---------- */
document.getElementById('addStudentBtn').addEventListener('click', ()=>{
  const first = document.getElementById('firstName').value.trim();
  const last  = document.getElementById('lastName').value.trim();
  const dob   = document.getElementById('dob').value;
  const belt  = document.getElementById('currentBelt').value;
  if(!first || !last || !dob || !belt){ alert('Please fill First, Last, DOB and Belt.'); return; }
  const students = getData('students');
  const id = generateStudentId(); if(id===null) return;
  students.push({ id, firstName: first, lastName: last, dob, currentBelt: belt, eligible: true });
  saveData('students', students);
  document.getElementById('firstName').value=''; document.getElementById('lastName').value=''; document.getElementById('dob').value=''; document.getElementById('currentBelt').value='';
  renderStudents();
});

document.getElementById('addTestBtn').addEventListener('click', ()=>{
  const sid = parseInt(document.getElementById('studentTestSelect').value || '0',10);
  const beltFor = document.getElementById('beltTestedFor').value;
  const dt = document.getElementById('testDate').value;
  const res = document.getElementById('testResult').value;
  const instrs = Array.from(document.getElementById('testInstructors').selectedOptions).map(o=>o.value);
  const locs = Array.from(document.getElementById('testLocations').selectedOptions).map(o=>o.value);
  const cmts = document.getElementById('comments').value.trim();
  if(!sid || !beltFor || !dt || !res){ alert('Please fill Student, Belt, Date, and Result.'); return; }
  const students = getData('students'); const s = students.find(x=>x.id===sid); if(!s){ alert('Student not found'); return; }
  const tests = getData('tests');
  const newTest = { id: generateTestId(), studentId: sid, studentName: `${s.firstName} ${s.lastName}`, beltTestedFor: beltFor, testDate: dt, result: res, comments: cmts, instructors: instrs, locations: locs };
  tests.push(newTest); saveData('tests', tests);
  if(res === 'Pass'){ s.currentBelt = beltFor; saveData('students', students); }
  // reset form
  document.getElementById('studentTestSelect').value=''; document.getElementById('beltTestedFor').value=''; document.getElementById('testDate').value=''; document.getElementById('testResult').value=''; document.getElementById('comments').value='';
  Array.from(document.getElementById('testInstructors').options).forEach(o=>o.selected=false);
  Array.from(document.getElementById('testLocations').options).forEach(o=>o.selected=false);
  renderStudents(); renderTests();
});

/* ---------- export JSON ---------- */
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('exportStudentsBtn').addEventListener('click', ()=> {
  const s = getData('students').map(x=> ({ ...x, eligible: !!normalizeEligible(x.eligible) }));
  downloadJSON('students.json', s);
});
document.getElementById('exportTestsBtn').addEventListener('click', ()=> {
  const t = getData('tests');
  downloadJSON('tests.json', t);
});
document.getElementById('exportAllBtn').addEventListener('click', ()=> {
  const payload = { students: getData('students').map(x=> ({ ...x, eligible: !!normalizeEligible(x.eligible) })), tests: getData('tests') };
  downloadJSON('backup.json', payload);
});

/* ---------- import helpers (single-type & combined) ---------- */
document.getElementById('importStudentsBtn').addEventListener('click', ()=> importStudentsFile.click());
document.getElementById('importTestsBtn').addEventListener('click', ()=> importTestsFile.click());
document.getElementById('importAllBtn').addEventListener('click', ()=> importAllFile.click());

importStudentsFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const parsed = JSON.parse(txt);
    if(!Array.isArray(parsed)){ alert('Students JSON must be an array'); importStudentsFile.value=''; return; }
    await handleImport(parsed, 'students');
  } catch(err){ alert('Invalid JSON'); }
  importStudentsFile.value='';
});

importTestsFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const parsed = JSON.parse(txt);
    if(!Array.isArray(parsed)){ alert('Tests JSON must be an array'); importTestsFile.value=''; return; }
    await handleImport(parsed, 'tests');
  } catch(err){ alert('Invalid JSON'); }
  importTestsFile.value='';
});

importAllFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const parsed = JSON.parse(txt);
    const stArr = Array.isArray(parsed.students) ? parsed.students : [];
    const tArr = Array.isArray(parsed.tests) ? parsed.tests : [];
    // merge students first, then tests
    await handleImport(stArr, 'students');
    await handleImport(tArr, 'tests');
    alert('Combined import finished.');
  } catch(err){ alert('Invalid JSON'); }
  importAllFile.value='';
});

/* ---------- merge + deletion flow ---------- */
async function handleImport(incomingArray, type){
  // type: 'students' or 'tests'
  if(!Array.isArray(incomingArray)) return;
  // normalize incoming
  let incoming = incomingArray.map(item => {
    if(type === 'students'){
      return { ...item, eligible: normalizeEligible(item.eligible) };
    } else {
      return { ...item, instructors: Array.isArray(item.instructors) ? item.instructors : String(item.instructors||'').split(',').map(s=>s.trim()).filter(Boolean), locations: Array.isArray(item.locations) ? item.locations : String(item.locations||'').split(',').map(s=>s.trim()).filter(Boolean) };
    }
  });

  const local = getData(type);
  const idField = 'id';

  // 1) add new
  const localById = new Map(local.map(x=>[String(x[idField]), x]));
  const incomingIds = new Set(incoming.map(x=>String(x[idField])));
  const newOnes = incoming.filter(x => !localById.has(String(x[idField])));
  if(newOnes.length){
    const merged = local.concat(newOnes);
    saveData(type, merged);
  }

  // 2) conflicts (per-field)
  mergeQueue = [];
  incoming.forEach(inc => {
    const cur = localById.get(String(inc[idField]));
    if(!cur) return;
    if(type === 'students'){
      if(studentDiffers(cur, inc)) mergeQueue.push({ type:'student', local: cur, incoming: inc });
    } else {
      if(testDiffers(cur, inc)) mergeQueue.push({ type:'test', local: cur, incoming: inc });
    }
  });

  // 3) local-only (candidate deletions)
  const localOnly = local.filter(x => !incomingIds.has(String(x[idField]))).map(x=>({ type, id: x[idField], label: (type==='students') ? `${x.firstName||''} ${x.lastName||''}`.trim() || `ID ${x[id]}` : `Test ${x[id]}` }));
  pendingDeletions = localOnly;

  // process queue sequentially (modal-driven)
  if(mergeQueue.length > 0){
    mergeIndex = 0;
    await processMergeQueueSequential();
  } else {
    // no conflicts — prompt deletions immediately
    await showDeletionPrompt(type);
  }
}

/* helper comparators */
function studentDiffers(a,b){
  return a.firstName !== b.firstName || a.lastName !== b.lastName || a.dob !== b.dob ||
         a.currentBelt !== b.currentBelt || !!normalizeEligible(a.eligible) !== !!normalizeEligible(b.eligible) ||
         (a.instructor||'') !== (b.instructor||'') || (a.location||'') !== (b.location||'');
}
function testDiffers(a,b){
  const arrEq = (x,y) => (x||[]).join('|') !== (y||[]).join('|');
  return a.studentName !== b.studentName || a.beltTestedFor !== b.beltTestedFor ||
         a.testDate !== b.testDate || a.result !== b.result ||
         arrEq(a.instructors,b.instructors) || arrEq(a.locations,b.locations) ||
         (a.comments||'') !== (b.comments||'');
}

/* build diff UI */
function buildDiffTable(fields, local, incoming){
  const table = document.createElement('table'); table.className='diff-table';
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Field</th><th>Current</th><th>Imported</th><th>Keep</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  fields.forEach(f=>{
    const tr = document.createElement('tr');
    const curVal = formatFieldValue(f, local[f]);
    const incVal = formatFieldValue(f, incoming[f]);
    tr.innerHTML = `<td><strong>${f}</strong></td>
      <td class="diff">${escapeHtml(curVal)}</td>
      <td class="diff">${escapeHtml(incVal)}</td>
      <td>
        <label><input type="radio" name="keep-${f}" value="current" checked> Current</label>
        <label style="margin-left:8px"><input type="radio" name="keep-${f}" value="incoming"> Imported</label>
      </td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  return table;
}
function escapeHtml(str){ return String(str==null ? '' : str).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch])); }
function formatFieldValue(field,val){
  if(field === 'eligible') return normalizeEligible(val) ? 'true' : 'false';
  if(Array.isArray(val)) return val.join(', ');
  return val == null ? '' : String(val);
}

/* sequential processing of mergeQueue via modal and promises */
function showMergeItem(item, i, total){
  const isStudent = item.type === 'student';
  mergeTitle.textContent = `${isStudent ? 'Student' : 'Test'} Conflict (${i+1} of ${total}) — ID: ${item.local.id || item.local.id}`;
  const fields = isStudent ? ['firstName','lastName','dob','currentBelt','eligible','instructor','location'] : ['studentName','beltTestedFor','testDate','result','instructors','locations','comments'];
  mergeContent.innerHTML = '';
  mergeContent.appendChild(buildDiffTable(fields, item.local, item.incoming));
  mergePrevBtn.disabled = (i === 0);
  openModal('mergeModal');
}

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

function processMergeQueueSequential(){
  return new Promise(resolve => {
    async function next(){
      if(mergeIndex >= mergeQueue.length){
        // done with merges — prompt deletions
        closeModal('mergeModal');
        await showDeletionPrompt(mergeQueue.length ? mergeQueue[0].type==='student' ? 'students' : 'tests' : pendingDeletions.length ? pendingDeletions[0].type : 'students');
        resolve();
        return;
      }
      const item = mergeQueue[mergeIndex];
      showMergeItem(item, mergeIndex, mergeQueue.length);

      // wait for user action
      const onApply = ()=>{
        const fields = (item.type==='student') ? ['firstName','lastName','dob','currentBelt','eligible','instructor','location'] : ['studentName','beltTestedFor','testDate','result','instructors','locations','comments'];
        const form = mergeContent;
        fields.forEach(f=>{
          const choice = form.querySelector(`input[name="keep-${f}"]:checked`)?.value || 'current';
          if(choice === 'incoming'){
            if(f==='eligible'){ item.local[f] = !!item.incoming[f]; }
            else if(f==='instructors' || f==='locations'){ item.local[f] = Array.isArray(item.incoming[f]) ? item.incoming[f] : String(item.incoming[f]||'').split(',').map(s=>s.trim()).filter(Boolean); }
            else item.local[f] = item.incoming[f];
          }
        });
        // save local updated record
        if(item.type === 'student'){
          const arr = getData('students'); const idx = arr.findIndex(x=>String(x.id) === String(item.local.id));
          if(idx >= 0){ arr[idx] = item.local; saveData('students', arr); }
        } else {
          const arr = getData('tests'); const idx = arr.findIndex(x=>String(x.id) === String(item.local.id));
          if(idx >= 0){ arr[idx] = item.local; saveData('tests', arr); }
        }
        mergeIndex++;
        // small delay to allow UI update
        setTimeout(next, 50);
      };

      const onSkip = ()=>{
        mergeIndex++;
        setTimeout(next, 50);
      };

      const onPrev = ()=>{
        if(mergeIndex > 0){ mergeIndex--; setTimeout(next, 50); }
        else { /* nothing */ }
      };

      mergeApplyBtn.onclick = ()=>{ closeModal('mergeModal'); onApply(); };
      mergeSkipBtn.onclick = ()=>{ closeModal('mergeModal'); onSkip(); };
      mergePrevBtn.onclick = ()=>{ closeModal('mergeModal'); onPrev(); };
    }
    next();
  });
}

/* ---------- deletion prompt UI ---------- */
async function showDeletionPrompt(type){
  if(!pendingDeletions || pendingDeletions.length === 0){
    renderStudents(); renderTests(); alert(`${type === 'students' ? 'Student' : 'Test'} import complete.`);
    return;
  }
  // Build list: pendingDeletions contains objects {type,id,label}
  deleteTitle.textContent = `Local-only ${type} records not present in import`;
  deleteContent.innerHTML = '';
  const listDiv = document.createElement('div');
  pendingDeletions.forEach(item => {
    const id = item.id; const label = item.label || `${type.slice(0,-1)} ${id}`;
    const row = document.createElement('label'); row.style.display='block'; row.style.margin='6px 0';
    row.innerHTML = `<input type="checkbox" value="${id}"> ${escapeHtml(label)} (ID: ${escapeHtml(String(id))})`;
    listDiv.appendChild(row);
  });
  deleteContent.appendChild(listDiv);
  openModal('deleteModal');

  deleteConfirmBtn.onclick = ()=>{
    const checked = Array.from(deleteContent.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
    if(checked.length === 0){ closeModal('deleteModal'); pendingDeletions = []; renderStudents(); renderTests(); alert('No records deleted. Import complete.'); return; }
    if(type === 'students'){
      let s = getData('students').filter(x => !checked.includes(String(x.id)));
      saveData('students', s);
      // cascade tests removal
      let t = getData('tests').filter(x => !checked.includes(String(x.studentId)));
      saveData('tests', t);
    } else {
      let t = getData('tests').filter(x => !checked.includes(String(x.id)));
      saveData('tests', t);
    }
    pendingDeletions = [];
    closeModal('deleteModal');
    renderStudents(); renderTests();
    alert('Selected local records deleted.');
  };

  deleteCancelBtn.onclick = ()=>{
    closeModal('deleteModal');
    pendingDeletions = [];
    renderStudents(); renderTests();
    alert('Kept all local records. Import complete.');
  };
}

/* ---------- simple file-read utilities ---------- */
function readJsonFromFileInput(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = e => {
      try{ resolve(JSON.parse(e.target.result)); } catch(err){ reject(err); }
    };
    reader.onerror = err => reject(err);
    reader.readAsText(file);
  });
}

/* ---------- top-level import handlers (previously used simple approach) ---------- */
/* The handleImport function above is the main importer and merges + deletion prompt. */

/* ---------- other UI actions: print, reset ---------- */
document.getElementById('printStudentsBtn').addEventListener('click', ()=>{
  const w = window.open('','Print','width=900,height=700'); w.document.write('<html><head><title>Students</title></head><body>'+document.querySelector('.printable').outerHTML+'</body></html>'); w.document.close(); w.print(); w.close();
});
document.getElementById('printTestsBtn').addEventListener('click', ()=>{
  const w = window.open('','Print','width=900,height=700'); w.document.write('<html><head><title>Tests</title></head><body>'+document.getElementById('testsTable').outerHTML+'</body></html>'); w.document.close(); w.print(); w.close();
});

document.getElementById('resetDemoBtn').addEventListener('click', ()=>{
  if(confirm('Reset demo data? This will erase students and tests.')){ localStorage.removeItem('students'); localStorage.removeItem('tests'); location.reload(); }
});

/* ---------- wire small controls ---------- */
document.getElementById('importStudentsBtn').addEventListener('click', ()=> importStudentsFile.click());
document.getElementById('importTestsBtn').addEventListener('click', ()=> importTestsFile.click());
document.getElementById('importAllBtn').addEventListener('click', ()=> importAllFile.click());

importStudentsFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{ const parsed = await readJsonFromFileInput(f); if(!Array.isArray(parsed)){ alert('Students JSON must be an array'); e.target.value=''; return; } await handleImport(parsed, 'students'); }
  catch(err){ alert('Invalid JSON'); }
  e.target.value='';
});
importTestsFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{ const parsed = await readJsonFromFileInput(f); if(!Array.isArray(parsed)){ alert('Tests JSON must be an array'); e.target.value=''; return; } await handleImport(parsed, 'tests'); }
  catch(err){ alert('Invalid JSON'); }
  e.target.value='';
});
importAllFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const parsed = await readJsonFromFileInput(f);
    const stArr = Array.isArray(parsed.students) ? parsed.students : [];
    const tArr = Array.isArray(parsed.tests) ? parsed.tests : [];
    await handleImport(stArr, 'students');
    await handleImport(tArr, 'tests');
    alert('Backup import finished.');
  } catch(err){ alert('Invalid JSON'); }
  e.target.value='';
});

/* export buttons */
document.getElementById('exportStudentsBtn').addEventListener('click', ()=> {
  const s = getData('students').map(x=> ({ ...x, eligible: !!normalizeEligible(x.eligible) }));
  downloadJSON('students.json', s);
});
document.getElementById('exportTestsBtn').addEventListener('click', ()=> {
  downloadJSON('tests.json', getData('tests'));
});
document.getElementById('exportAllBtn').addEventListener('click', ()=>{
  const payload = { students: getData('students').map(x=> ({ ...x, eligible: !!normalizeEligible(x.eligible) })), tests: getData('tests') };
  downloadJSON('backup.json', payload);
});
function downloadJSON(name, obj){ const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

/* ---------- initial render ---------- */
renderStudents();
renderTests();

/* ---------- search ---------- */
document.getElementById('searchInput').addEventListener('input', renderStudents);

</script>
</body>
</html>