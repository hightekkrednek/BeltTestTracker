<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taekwondo Tracker</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f4f9; color:#333; }
h1 { text-align:center; margin:20px 0; }
h2 { margin-top:0; }
section { background:#fff; margin:20px auto; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.05); max-width:1000px; }
table { width:100%; border-collapse:collapse; margin-bottom:20px; overflow-x:auto; display:block; }
th,td { padding:10px; border:1px solid #ddd; text-align:left; font-size:14px; white-space:nowrap; }
th { background:#e2e2f1; }
input[type="text"], input[type="number"], input[type="date"], select { width:95%; padding:6px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; }
input[type="checkbox"] { width:20px; height:20px; }
button { margin:5px; padding:6px 10px; border-radius:4px; border:none; background:#6c63ff; color:#fff; cursor:pointer; font-size:12px; }
button:hover { background:#534fd1; }
.control-panel { background:#e8e8f8; padding:20px; border-radius:8px; margin:20px auto; max-width:1000px; }
.belt-White{background:#ffffff;}
.belt-White-Stripe{background:#f9f9f9;}
.belt-Yellow{background:#fffacd;}
.belt-Yellow-Stripe{background:#fff8b0;}
.belt-Green{background:#90ee90;}
.belt-Green-Stripe{background:#a0f0a0;}
.belt-Blue{background:#add8e6;}
.belt-Blue-Stripe{background:#b7dfee;}
.belt-Red{background:#ff7f7f;}
.belt-Red-Stripe{background:#ff9999;}
.belt-Black{background:#333333; color:#fff;}
.student-active{background:#e6ffe6;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;}
.modal-content { background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%; max-height:90%; overflow-y:auto; }
.modal-header { font-weight:bold; margin-bottom:10px; }
.modal-footer { text-align:right; margin-top:10px; }
select[multiple] { height:60px; }
li { margin-bottom:5px; }
li button { background:#ff4d4d; margin-left:5px; font-size:12px; padding:2px 6px; }
li .upBtn, li .downBtn { background:#4d94ff; margin-left:3px; }
</style>
</head>
<body>

<!-- TOP BANNER -->
<h1 style="
    text-align: center;
    background-color: #222;
    color: white;
    padding: 15px 0;
    margin: 0;
    font-family: Arial, sans-serif;
    font-size: 2em;
    border-bottom: 4px solid #ffcc00;
">
    Impact Martial Arts Belt Tracker
</h1>

<section id="dashboard">
<h2>Dashboard</h2>
<div id="beltCounts">No students yet.</div>
</section>

<!-- STUDENTS SECTION -->
<section id="studentsSection">
  <h2>Students</h2>
  <div style="overflow-x:auto;">
    <table id="studentsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Birthdate</th>
          <th>Age</th>
          <th>Belt</th>
          <th>Instructor</th>
          <th>Location</th>
          <th>Eligible</th>
          <th>Active</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <button onclick="openStudentModal()">Add Student</button>
</section>

<section id="beltTestsSection">
<h2>Belt Tests</h2>
<table id="beltTestsTable">
<thead>
<tr>
<th>Student</th>
<th>Belt</th>
<th>Date</th>
<th>Instructor(s)</th>
<th>Location</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
<button onclick="openTestModal()">Add Belt Test</button>
</section>

<section class="control-panel">
<h2>Control Panel</h2>
<div>
<button onclick="openBeltModal()">Manage Belts</button>
<button onclick="openInstructorModal()">Manage Instructors</button>
<button onclick="openLocationModal()">Manage Locations</button>
</div>
<div>
<button onclick="importAll()">Import Data</button>
<button onclick="exportAll()">Export Data</button>
</div>
<div>
<button onclick="resetData()">Reset Data</button>
</div>
</section>

<!-- MODALS -->
<div class="modal" id="studentModal">
<div class="modal-content">
<div class="modal-header">Add/Edit Student</div>
<div class="modal-body">
<label>Name: <input type="text" id="studentName"></label><br><br>
<label>Birthdate: <input type="date" id="studentBirthdate"></label><br><br>
<label>Belt: <select id="studentBelt"></select></label><br><br>
<label>Instructor: <select id="studentInstructor"></select></label><br><br>
<label>Location: <select id="studentLocation"></select></label><br><br>
<label>Eligible: <input type="checkbox" id="studentEligible"></label><br><br>
<label>Active: <input type="checkbox" id="studentActive"></label>
</div>
<div class="modal-footer">
<button onclick="closeStudentModal()">Cancel</button>
<button onclick="saveStudent()">Save</button>
</div>
</div>
</div>

<div class="modal" id="testModal">
<div class="modal-content">
<div class="modal-header">Add/Edit Belt Test</div>
<div class="modal-body">
<label>Student: <select id="testStudentId"></select></label><br><br>
<label>Belt: <select id="testBelt"></select></label><br><br>
<label>Date: <input type="date" id="testDate"></label><br><br>
<label>Instructor(s): <select id="testInstructors" multiple></select></label><br><br>
<label>Location: <select id="testLocation"></select></label>
</div>
<div class="modal-footer">
<button onclick="closeTestModal()">Cancel</button>
<button onclick="saveTest()">Save</button>
</div>
</div>
</div>

<!-- Belt, Instructor, Location modals remain unchanged -->

<script>
// DATA
let students=[], beltTests=[], instructors=[], locations=[], belts=["White","White Stripe","Yellow","Yellow Stripe","Green","Green Stripe","Blue","Blue Stripe","Red","Red Stripe","Black"], nextStudentId=1000;
let editingStudent=null, editingTest=null;

// STORAGE
function saveAllData(){
  localStorage.setItem('students',JSON.stringify(students));
  localStorage.setItem('beltTests',JSON.stringify(beltTests));
  localStorage.setItem('instructors',JSON.stringify(instructors));
  localStorage.setItem('locations',JSON.stringify(locations));
  localStorage.setItem('belts',JSON.stringify(belts));
  localStorage.setItem('nextStudentId',nextStudentId);
}
function loadAllData(){
  students=JSON.parse(localStorage.getItem('students')||'[]');
  beltTests=JSON.parse(localStorage.getItem('beltTests')||'[]');
  instructors=JSON.parse(localStorage.getItem('instructors')||'[]');
  locations=JSON.parse(localStorage.getItem('locations')||'[]');
  belts=JSON.parse(localStorage.getItem('belts')||JSON.stringify(belts));
  nextStudentId=parseInt(localStorage.getItem('nextStudentId')||'1000');
}

// UTILITY: Calculate age
function calculateAge(dob){
  if(!dob) return '';
  const birth = new Date(dob);
  const diffMs = Date.now() - birth.getTime();
  const ageDt = new Date(diffMs);
  return Math.abs(ageDt.getUTCFullYear() - 1970);
}

// DASHBOARD
function updateBeltCounts(){
  if(students.length===0){document.getElementById('beltCounts').innerText="No students yet.";return;}
  let counts={};
  students.forEach(s=>{ counts[s.belt]=(counts[s.belt]||0)+1; });
  document.getElementById('beltCounts').innerText=Object.entries(counts).map(([b,n])=>`${b}: ${n}`).join(', ');
}

// POPULATE TABLES
function populateTables(){
  const tbodyS=document.querySelector('#studentsTable tbody'); tbodyS.innerHTML='';
  students.forEach(s=>{ addStudentRowToTable(s); });
  const tbodyT=document.querySelector('#beltTestsTable tbody'); tbodyT.innerHTML='';
  beltTests.forEach(t=>{ addTestRowToTable(t); });
  updateBeltCounts();
  populateBeltSelector();
}
function beltClassName(belt){ return 'belt-'+belt.replace(/\s/g,'-'); }
function populateBeltSelector(){
  const sel=document.getElementById('studentBelt'); sel.innerHTML='';
  belts.forEach(b=>{const o=document.createElement('option'); o.value=b; o.text=b; sel.add(o);});
  const testSel=document.getElementById('testBelt'); testSel.innerHTML='';
  belts.forEach(b=>{const o=document.createElement('option'); o.value=b; o.text=b; testSel.add(o);});
}

// STUDENTS
function addStudentRowToTable(s){
  const tbody=document.querySelector('#studentsTable tbody');
  const row=document.createElement('tr'); if(s.active) row.classList.add('student-active');
  row.innerHTML=`
    <td>${s.id}</td>
    <td>${s.name}</td>
    <td>${s.birthdate}</td>
    <td>${calculateAge(s.birthdate)}</td>
    <td class="${beltClassName(s.belt)}">${s.belt}</td>
    <td>${s.instructors.join(',')}</td>
    <td>${s.location}</td>
    <td>${s.eligible?'✔':''}</td>
    <td>${s.active?'✔':''}</td>
    <td><button onclick="editStudent(${s.id})">Edit</button><button onclick="deleteStudent(${s.id})">Delete</button></td>
  `;
  tbody.appendChild(row);
}
function editStudent(id){ const s=students.find(x=>x.id===id); if(s) openStudentModal(s);}
function deleteStudent(id){ if(confirm('Delete student?')){ students=students.filter(x=>x.id!==id); saveAllData(); populateTables(); }}

// BELT TESTS
function openTestModal(t=null){
  editingTest=t;
  const studentSel=document.getElementById('testStudentId'); studentSel.innerHTML='';
  students.filter(s=>s.active && s.eligible).forEach(s=>{ 
    const o=document.createElement('option'); o.value=s.id; o.text=`${s.name} (${s.id})`; if(t&&t.studentId===s.id)o.selected=true; studentSel.add(o); });
  document.getElementById('testBelt').value=t?t.belt:belts[0];
  document.getElementById('testDate').value=t?t.date:'';
  const selI=document.getElementById('testInstructors'); selI.innerHTML='';
  instructors.forEach(i=>{ const o=document.createElement('option'); o.value=i; o.text=i; if(t&&t.instructors.includes(i)) o.selected=true; selI.add(o); });
  const selL=document.getElementById('testLocation'); selL.innerHTML='';
  locations.forEach(l=>{ const o=document.createElement('option'); o.value=l; o.text=l; if(t&&t.location===l) o.selected=true; selL.add(o); });
  document.getElementById('testModal').style.display='flex';
}
function closeTestModal(){ document.getElementById('testModal').style.display='none'; editingTest=null; }
function saveTest(){
  const studentId=parseInt(document.getElementById('testStudentId').value);
  const belt=document.getElementById('testBelt').value;
  const date=document.getElementById('testDate').value;
  if(isNaN(studentId)||!belt||!date){alert('Student, Belt, and Date required'); return;}
  const instructorsSelected=[...document.getElementById('testInstructors').selectedOptions].map(o=>o.value);
  const location=document.getElementById('testLocation').value;
  if(editingTest){
    editingTest.studentId=studentId; editingTest.belt=belt; editingTest.date=date; editingTest.instructors=instructorsSelected; editingTest.location=location;
  } else {
    beltTests.push({studentId,belt,date,instructors:instructorsSelected,location});
  }
  // NEW FEATURE: update student belt automatically
  const student=students.find(s=>s.id===studentId);
  if(student) student.belt=belt;
  saveAllData(); populateTables(); closeTestModal();
}
function addTestRowToTable(t){
  const tbody=document.querySelector('#beltTestsTable tbody');
  const s=students.find(st=>st.id===t.studentId);
  const studentName=s?s.name+' ('+s.id+')':'Unknown';
  const row=document.createElement('tr'); 
  row.innerHTML=`
    <td>${studentName}</td>
    <td class="${beltClassName(t.belt)}">${t.belt}</td>
    <td>${t.date}</td>
    <td>${t.instructors.join(',')}</td>
    <td>${t.location}</td>
    <td><button onclick="editTest(${beltTests.indexOf(t)})">Edit</button><button onclick="deleteTest(${beltTests.indexOf(t)})">Delete</button></td>
  `;
  tbody.appendChild(row);
}
function editTest(index){ openTestModal(beltTests[index]); }
function deleteTest(index){ if(confirm('Delete this test?')){ beltTests.splice(index,1); saveAllData(); populateTables(); }}

// BELT MANAGEMENT
function openBeltModal(){
  const ul=document.getElementById('beltList'); ul.innerHTML='';
  belts.forEach((b,i)=>{ const li=document.createElement('li'); li.innerHTML=`${b} <button class="upBtn" onclick="moveBeltUp(${i})">↑</button><button class="downBtn" onclick="moveBeltDown(${i})">↓</button><button onclick="deleteBelt(${i})">X</button>`; ul.appendChild(li); });
  document.getElementById('beltModal').style.display='flex';
}
function closeBeltModal(){ document.getElementById('beltModal').style.display='none'; saveAllData(); populateTables();}
function addBelt(){ const val=document.getElementById('newBeltName').value.trim(); if(val){ belts.push(val); document.getElementById('newBeltName').value=''; openBeltModal();}}
function moveBeltUp(i){ if(i>0){ [belts[i-1],belts[i]]=[belts[i],belts[i-1]]; openBeltModal(); }}
function moveBeltDown(i){ if(i<belts.length-1){ [belts[i],belts[i+1]]=[belts[i+1],belts[i]]; openBeltModal(); }}
function deleteBelt(i){ if(confirm('Delete this belt?')){ belts.splice(i,1); openBeltModal(); } }

// INSTRUCTOR MANAGEMENT
function openInstructorModal(){
  const ul=document.getElementById('instructorList'); ul.innerHTML='';
  instructors.forEach((i,idx)=>{
    const li=document.createElement('li');
    li.innerHTML=`${i} <button onclick="editInstructor(${idx})">Edit</button><button onclick="deleteInstructor(${idx})">X</button>`;
    ul.appendChild(li);
  });
  document.getElementById('instructorModal').style.display='flex';
}
function closeInstructorModal(){ document.getElementById('instructorModal').style.display='none'; saveAllData(); populateTables();}
function addInstructor(){ const val=document.getElementById('newInstructorName').value.trim(); if(val){instructors.push(val); document.getElementById('newInstructorName').value=''; openInstructorModal();}}
function editInstructor(idx){ const val=prompt('Edit instructor', instructors[idx]); if(val) { instructors[idx]=val; openInstructorModal(); } }
function deleteInstructor(idx){ if(confirm('Delete this instructor?')){ instructors.splice(idx,1); openInstructorModal(); } }

// LOCATION MANAGEMENT
function openLocationModal(){
  const ul=document.getElementById('locationList'); ul.innerHTML='';
  locations.forEach((l,idx)=>{
    const li=document.createElement('li');
    li.innerHTML=`${l} <button onclick="editLocation(${idx})">Edit</button><button onclick="deleteLocation(${idx})">X</button>`;
    ul.appendChild(li);
  });
  document.getElementById('locationModal').style.display='flex';
}
function closeLocationModal(){ document.getElementById('locationModal').style.display='none'; saveAllData(); populateTables();}
function addLocation(){ const val=document.getElementById('newLocationName').value.trim(); if(val){locations.push(val); document.getElementById('newLocationName').value=''; openLocationModal();}}
function editLocation(idx){ const val=prompt('Edit location', locations[idx]); if(val) { locations[idx]=val; openLocationModal(); } }
function deleteLocation(idx){ if(confirm('Delete this location?')){ locations.splice(idx,1); openLocationModal(); } }

// IMPORT/EXPORT ALL DATA
function exportAll(){
  const allData={students, beltTests, instructors, locations, belts};
  const blob=new Blob([JSON.stringify(allData,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='taekwondoData.json'; a.click();
}
//function importAll(){ alert('Import functionality coming soon'); } // placeholder

function importAll() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const importedData = JSON.parse(event.target.result);
        if(!importedData) return;

        // ---- STUDENTS ----
        if(importedData.students){
          importedData.students.forEach(iStu => {
            const existing = students.find(s => s.id === iStu.id);
            if(existing){
              // Check for differences
              const diffs = [];
              ['name','birthdate','belt','instructors','location','eligible','active'].forEach(key=>{
                if(JSON.stringify(existing[key]) !== JSON.stringify(iStu[key])){
                  diffs.push(`${key}: current="${JSON.stringify(existing[key])}", imported="${JSON.stringify(iStu[key])}"`);
                }
              });
              if(diffs.length>0){
                if(confirm(`Student ID ${iStu.id} has differences:\n${diffs.join('\n')}\nOverwrite with imported values?`)){
                  Object.assign(existing,iStu);
                }
              }
            } else {
              students.push(iStu);
              if(iStu.id >= nextStudentId) nextStudentId = iStu.id + 1;
            }
          });
        }

        // ---- BELT TESTS ----
        if(importedData.beltTests){
          importedData.beltTests.forEach(iTest => {
            const exists = beltTests.find(bt => JSON.stringify(bt)===JSON.stringify(iTest));
            if(!exists) beltTests.push(iTest);
          });
        }

        // ---- INSTRUCTORS ----
        if(importedData.instructors){
          importedData.instructors.forEach(i => {
            if(!instructors.includes(i)) instructors.push(i);
          });
        }

        // ---- LOCATIONS ----
        if(importedData.locations){
          importedData.locations.forEach(l => {
            if(!locations.includes(l)) locations.push(l);
          });
        }

        // ---- BELTS ----
        if(importedData.belts){
          importedData.belts.forEach(b => {
            if(!belts.includes(b)) belts.push(b);
          });
        }

        saveAllData();
        populateTables();
        alert('Import complete.');
      } catch(err){
        alert('Error importing JSON: '+err);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// RESET DATA
function resetData(){ if(confirm('Reset all data?')){ students=[]; beltTests=[]; instructors=[]; locations=[]; belts=["White","White Stripe","Yellow","Yellow Stripe","Green","Green Stripe","Blue","Blue Stripe","Red","Red Stripe","Black"]; nextStudentId=1000; saveAllData(); populateTables(); }}

// INITIALIZE
loadAllData();
populateTables();
</script>
</body>
</html>