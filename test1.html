<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Taekwondo Belt Tracker</title>
<style>
  :root{
    --bg:#f7f8fa; --card:#fff; --ink:#222; --muted:#666; --acc:#1565c0;
    --danger:#d32f2f; --border:#e0e0e0; --overlay:#0008;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,Segoe UI,Arial,sans-serif; color:var(--ink); background:var(--bg)}
  .container{max-width:1200px; margin:24px auto; padding:0 16px}
  h1{margin:0 0 16px}
  .row{display:grid; gap:16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:16px}
  .dashboard{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#fff; font-weight:600}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0}
  input,select,textarea,button{padding:8px 10px; border:1px solid var(--border); border-radius:8px; font:inherit}
  button{background:var(--acc); color:#fff; cursor:pointer; border:none}
  button.secondary{background:#fff; color:var(--ink); border:1px solid var(--border)}
  button.danger{background:var(--danger)}
  table{width:100%; border-collapse:collapse}
  th,td{border-top:1px solid var(--border); padding:8px; text-align:left; vertical-align:top}
  th{background:#fafafa}
  td[contenteditable="true"]{background:#fffef3}
  .belt-White{background:#fff}
  .belt-Yellow{background:#fff59d}
  .belt-Green{background:#a5d6a7}
  .belt-Blue{background:#81d4fa}
  .belt-Red{background:#ef9a9a}
  .belt-Black{background:#000; color:#fff}
  .stack{display:flex; gap:8px; flex-wrap:wrap}
  .grow{flex:1}
  .inline{display:inline-flex; gap:6px; align-items:center}
  .tag{display:inline-block; padding:2px 6px; border:1px solid var(--border); border-radius:999px; background:#fff; margin:2px 4px 2px 0; font-size:12px}
  /* Modals */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:var(--overlay); z-index:1000}
  .modal.open{display:flex}
  .modal-card{width:min(720px,92vw); max-height:86vh; overflow:auto; background:#fff; border-radius:12px; border:1px solid var(--border); box-shadow:0 12px 30px #0003}
  .modal-header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
  .modal-body{padding:14px 16px}
  .grid-2{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .list-table td:nth-child(2){width:1%}
  @media print{
    body *{visibility:hidden}
    .printable, .printable *{visibility:visible}
    .printable{position:absolute; inset:0}
    button{display:none}
  }
</style>
</head>
<body>
<div class="container">
  <h1>Taekwondo Belt Tracker</h1>

  <!-- Dashboard (belt counts only) -->
  <div class="card">
    <div id="beltCounts" class="dashboard"></div>
  </div>

  <!-- Global controls -->
  <div class="controls">
    <input id="searchInput" class="grow" placeholder="Search by student, belt, instructor, or location..."/>
    <button id="exportStudentsBtn" class="secondary">Export Students CSV</button>
    <button id="exportTestsBtn" class="secondary">Export Tests CSV</button>
    <button id="printStudentsBtn" class="secondary">Print Students</button>
    <button id="printTestsBtn" class="secondary">Print Tests</button>
    <button id="manageInstructorsBtn">Manage Instructors</button>
    <button id="manageLocationsBtn">Manage Locations</button>
    <button id="resetDemoBtn" class="danger">Reset Demo</button>
  </div>

  <!-- Add Student -->
  <div class="card">
    <h2>Add New Student</h2>
    <div class="row" style="grid-template-columns:repeat(6,1fr)">
      <input id="firstName" placeholder="First Name" required />
      <input id="lastName" placeholder="Last Name" required />
      <input id="dob" type="date" required />
      <select id="currentBelt" required>
        <option value="">Belt</option>
        <option>White</option><option>Yellow</option><option>Green</option>
        <option>Blue</option><option>Red</option><option>Black</option>
      </select>
      <select id="instructorSelect" required></select>
      <select id="locationSelect" required></select>
    </div>
    <div class="controls">
      <button id="addStudentBtn">Add Student</button>
    </div>
  </div>

  <!-- Students -->
  <div class="card printable" id="studentsCard">
    <h2>Students</h2>
    <table id="studentsTable">
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>DOB</th><th>Current Belt</th>
          <th>Eligible?</th><th>Instructor</th><th>Location</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Record Belt Test -->
  <div class="card">
    <h2>Record Belt Test</h2>
    <div class="row" style="grid-template-columns:repeat(6,1fr)">
      <select id="studentTestSelect"></select>
      <select id="beltTestedFor">
        <option value="">Belt Tested For</option>
        <option>Yellow</option><option>Green</option>
        <option>Blue</option><option>Red</option><option>Black</option>
      </select>
      <input id="testDate" type="date"/>
      <select id="testResult">
        <option value="">Result</option><option>Pass</option><option>Fail</option>
      </select>
      <select id="testInstructors" multiple size="4" title="Hold Ctrl/Cmd to select multiple"></select>
      <select id="testLocations" multiple size="4" title="Hold Ctrl/Cmd to select multiple"></select>
    </div>
    <textarea id="comments" class="grow" rows="3" placeholder="Comments (optional)"></textarea>
    <div class="controls">
      <button id="addTestBtn">Record Test</button>
    </div>
  </div>

  <!-- Tests -->
  <div class="card printable" id="testsCard">
    <h2>Belt Test Records</h2>
    <table id="testsTable">
      <thead>
        <tr>
          <th>Student</th><th>Belt Tested For</th><th>Date</th><th>Result</th>
          <th>Instructors</th><th>Locations</th><th>Comments</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Instructors Modal -->
<div id="instructorsModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Manage Instructors</h3>
      <button class="secondary" onclick="closeModal('instructorsModal')">Close</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <input id="instructorName" placeholder="New instructor name"/>
        <button onclick="addInstructor()">Add</button>
      </div>
      <table class="list-table" style="margin-top:10px; width:100%">
        <thead><tr><th>Instructor</th><th>Actions</th></tr></thead>
        <tbody id="instructorTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Locations Modal -->
div id="locationsModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h3>Manage Locations</h3>
      <button class="secondary" onclick="closeModal('locationsModal')">Close</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <input id="locationName" placeholder="New location name"/>
        <button onclick="addLocation()">Add</button>
      </div>
      <table class="list-table" style="margin-top:10px; width:100%">
        <thead><tr><th>Location</th><th>Actions</th></tr></thead>
        <tbody id="locationTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ---------- Storage helpers ----------
  const getData = key => JSON.parse(localStorage.getItem(key) || '[]');
  const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

  // ---------- IDs ----------
  function generateStudentId(){
    const students=getData('students');
    if(students.length===0) return 1000;
    const maxId=students.reduce((m,s)=>s.id>m?s.id:m,1000);
    if(maxId>=9999){ alert('Max students reached (9999).'); return null; }
    return maxId+1;
  }
  const generateTestId = () => 't'+Date.now().toString(36)+Math.random().toString(36).slice(2,7);

  // ---------- Demo seed ----------
  (function seed(){
    if(!localStorage.getItem('instructors')){
      saveData('instructors', ['John Smith','Jane Doe','Master Park']);
    }
    if(!localStorage.getItem('locations')){
      saveData('locations', ['Main Dojo','East Dojo','West Dojo']);
    }
    if(!localStorage.getItem('students')){
      saveData('students', [
        {id:1000,firstName:'Ethan',lastName:'Lee',dob:'2015-04-10',currentBelt:'White',eligible:'✔',instructor:'John Smith',location:'Main Dojo'},
        {id:1001,firstName:'Evelyn',lastName:'Kim',dob:'2016-07-22',currentBelt:'Yellow',eligible:'✔',instructor:'Jane Doe',location:'East Dojo'},
        {id:1002,firstName:'Liam',lastName:'Chen',dob:'2014-11-05',currentBelt:'Green',eligible:'✔',instructor:'John Smith',location:'Main Dojo'}
      ]);
    }
    if(!localStorage.getItem('tests')){
      saveData('tests', [
        {id:generateTestId(),studentId:1000,studentName:'Ethan Lee',beltTestedFor:'White',testDate:'2025-08-01',result:'Pass',comments:'Great start!',instructors:['John Smith'],locations:['Main Dojo']},
        {id:generateTestId(),studentId:1001,studentName:'Evelyn Kim',beltTestedFor:'Yellow',testDate:'2025-07-15',result:'Pass',comments:'Good techniques.',instructors:['Jane Doe'],locations:['East Dojo']},
        {id:generateTestId(),studentId:1002,studentName:'Liam Chen',beltTestedFor:'Green',testDate:'2025-06-20',result:'Pass',comments:'Needs flexibility.',instructors:['John Smith'],locations:['Main Dojo']}
      ]);
    }
  })();

  // ---------- Elements ----------
  const beltCountsDiv = document.getElementById('beltCounts');
  const searchInput = document.getElementById('searchInput');
  const exportStudentsBtn = document.getElementById('exportStudentsBtn');
  const exportTestsBtn = document.getElementById('exportTestsBtn');
  const printStudentsBtn = document.getElementById('printStudentsBtn');
  const printTestsBtn = document.getElementById('printTestsBtn');
  const resetDemoBtn = document.getElementById('resetDemoBtn');
  const manageInstructorsBtn = document.getElementById('manageInstructorsBtn');
  const manageLocationsBtn = document.getElementById('manageLocationsBtn');

  const instructorSelect = document.getElementById('instructorSelect');
  const locationSelect = document.getElementById('locationSelect');

  const addStudentBtn = document.getElementById('addStudentBtn');
  const studentsTableBody = document.querySelector('#studentsTable tbody');

  const studentTestSelect = document.getElementById('studentTestSelect');
  const beltTestedFor = document.getElementById('beltTestedFor');
  const testDate = document.getElementById('testDate');
  const testResult = document.getElementById('testResult');
  const testInstructors = document.getElementById('testInstructors');
  const testLocations = document.getElementById('testLocations');
  const comments = document.getElementById('comments');
  const addTestBtn = document.getElementById('addTestBtn');
  const testsTableBody = document.querySelector('#testsTable tbody');

  // Modals
  const instructorsModal = document.getElementById('instructorsModal');
  const locationsModal = document.getElementById('locationsModal');
  const instructorTableBody = document.getElementById('instructorTableBody');
  const locationTableBody = document.getElementById('locationTableBody');

  // ---------- Modal helpers ----------
  function openModal(id){ document.getElementById(id).classList.add('open'); }
  function closeModal(id){ document.getElementById(id).classList.remove('open'); }
  window.closeModal = closeModal;

  manageInstructorsBtn.onclick = ()=> openModal('instructorsModal');
  manageLocationsBtn.onclick = ()=> openModal('locationsModal');

  // ---------- Renderers ----------
  function renderDashboard(){
    const students = getData('students');
    const counts = {White:0,Yellow:0,Green:0,Blue:0,Red:0,Black:0};
    students.forEach(s => { if(counts[s.currentBelt]!=null) counts[s.currentBelt]++; });
    beltCountsDiv.innerHTML = '';
    Object.entries(counts).forEach(([belt,count])=>{
      const pill = document.createElement('div'); pill.className='pill';
      pill.style.background = belt === 'Black' ? '#000' : '';
      pill.style.color = belt === 'Black' ? '#fff' : '';
      pill.textContent = `${belt}: ${count}`;
      beltCountsDiv.appendChild(pill);
    });
  }

  function renderInstructorSelects(){
    const list = getData('instructors');
    instructorSelect.innerHTML = '<option value="">Select Instructor</option>';
    list.forEach(i=>{
      const opt = document.createElement('option'); opt.value=i; opt.textContent=i; instructorSelect.appendChild(opt);
    });
    // test multiselect
    testInstructors.innerHTML='';
    list.forEach(i=>{
      const opt=document.createElement('option'); opt.value=i; opt.textContent=i; testInstructors.appendChild(opt);
    });
  }
  function renderLocationSelects(){
    const list = getData('locations');
    locationSelect.innerHTML = '<option value="">Select Location</option>';
    list.forEach(l=>{
      const opt = document.createElement('option'); opt.value=l; opt.textContent=l; locationSelect.appendChild(opt);
    });
    // test multiselect
    testLocations.innerHTML='';
    list.forEach(l=>{
      const opt=document.createElement('option'); opt.value=l; opt.textContent=l; testLocations.appendChild(opt);
    });
  }

  function renderInstructorsModal(){
    const list=getData('instructors');
    instructorTableBody.innerHTML='';
    list.forEach((name, idx)=>{
      const tr=document.createElement('tr');
      const tdName=document.createElement('td');
      tdName.contentEditable=true; tdName.textContent=name;
      const tdAct=document.createElement('td');
      const save=document.createElement('button'); save.textContent='Save'; save.className='secondary';
      save.onclick=()=>{ const l=getData('instructors'); l[idx]=tdName.textContent.trim(); saveData('instructors',l); renderInstructorsModal(); renderInstructorSelects(); };
      const del=document.createElement('button'); del.textContent='Delete'; del.className='danger';
      del.onclick=()=>{ const l=getData('instructors'); l.splice(idx,1); saveData('instructors',l); renderInstructorsModal(); renderInstructorSelects(); };
      tdAct.append(save, ' ', del);
      tr.append(tdName, tdAct);
      instructorTableBody.appendChild(tr);
    });
  }
  function renderLocationsModal(){
    const list=getData('locations');
    locationTableBody.innerHTML='';
    list.forEach((name, idx)=>{
      const tr=document.createElement('tr');
      const tdName=document.createElement('td');
      tdName.contentEditable=true; tdName.textContent=name;
      const tdAct=document.createElement('td');
      const save=document.createElement('button'); save.textContent='Save'; save.className='secondary';
      save.onclick=()=>{ const l=getData('locations'); l[idx]=tdName.textContent.trim(); saveData('locations',l); renderLocationsModal(); renderLocationSelects(); };
      const del=document.createElement('button'); del.textContent='Delete'; del.className='danger';
      del.onclick=()=>{ const l=getData('locations'); l.splice(idx,1); saveData('locations',l); renderLocationsModal(); renderLocationSelects(); };
      tdAct.append(save, ' ', del);
      tr.append(tdName, tdAct);
      locationTableBody.appendChild(tr);
    });
  }

  // Add new instructor/location from modal header
  window.addInstructor = function(){
    const input = document.getElementById('instructorName');
    const name = input.value.trim(); if(!name) return;
    const list=getData('instructors'); list.push(name); saveData('instructors',list);
    input.value=''; renderInstructorsModal(); renderInstructorSelects();
  }
  window.addLocation = function(){
    const input = document.getElementById('locationName');
    const name = input.value.trim(); if(!name) return;
    const list=getData('locations'); list.push(name); saveData('locations',list);
    input.value=''; renderLocationsModal(); renderLocationSelects();
  }

  function renderStudents(){
    const students = getData('students');
    const filter = (searchInput.value||'').toLowerCase();
    studentsTableBody.innerHTML='';
    studentTestSelect.innerHTML = '<option value="">Select Student</option>';
    students.forEach(s=>{
      const nameFull = `${s.firstName} ${s.lastName}`;
      if(filter && !nameFull.toLowerCase().includes(filter)
         && !s.currentBelt.toLowerCase().includes(filter)
         && !(s.instructor||'').toLowerCase().includes(filter)
         && !(s.location||'').toLowerCase().includes(filter)) return;

      const tr=document.createElement('tr');
      const tdId=document.createElement('td'); tdId.textContent=s.id;
      const tdName=document.createElement('td'); tdName.contentEditable=true; tdName.textContent=nameFull;
      const tdDob=document.createElement('td'); tdDob.contentEditable=true; tdDob.textContent=s.dob;
      const tdBelt=document.createElement('td'); tdBelt.contentEditable=true; tdBelt.textContent=s.currentBelt; tdBelt.classList.add('belt-'+s.currentBelt);
      const tdElig=document.createElement('td'); tdElig.contentEditable=true; tdElig.textContent=s.eligible||''; tdElig.style.textAlign='center';
      const tdInstr=document.createElement('td'); tdInstr.contentEditable=true; tdInstr.textContent=s.instructor||'';
      const tdLoc=document.createElement('td'); tdLoc.contentEditable=true; tdLoc.textContent=s.location||'';
      const tdAct=document.createElement('td');
      const save=document.createElement('button'); save.textContent='Save';
      save.onclick=()=> saveStudentInline(s.id, tdName, tdDob, tdBelt, tdElig, tdInstr, tdLoc);
      const del=document.createElement('button'); del.textContent='Delete'; del.className='danger';
      del.onclick=()=> deleteStudent(s.id);
      tdAct.append(save,' ',del);

      tr.append(tdId, tdName, tdDob, tdBelt, tdElig, tdInstr, tdLoc, tdAct);
      studentsTableBody.appendChild(tr);

      const opt=document.createElement('option'); opt.value=s.id; opt.textContent=nameFull; studentTestSelect.appendChild(opt);
    });
    renderDashboard();
    renderTests(); // keep test list fresh (names may change)
  }

  function saveStudentInline(id, nameCell, dobCell, beltCell, eligCell, instrCell, locCell){
    const students=getData('students');
    const s = students.find(x=>x.id===id); if(!s) return;
    const names = nameCell.textContent.trim().split(/\s+/);
    if(names.length<2){ alert('Please enter full name'); renderStudents(); return; }
    const belts = ['White','Yellow','Green','Blue','Red','Black'];
    const belt = beltCell.textContent.trim();
    if(!belts.includes(belt)){ alert('Invalid belt'); renderStudents(); return; }
    s.firstName=names[0];
    s.lastName=names.slice(1).join(' ');
    s.dob=dobCell.textContent.trim();
    s.currentBelt=belt;
    s.eligible=eligCell.textContent.trim(); // ✔ or empty
    s.instructor=instrCell.textContent.trim();
    s.location=locCell.textContent.trim();
    saveData('students', students);
    renderStudents();
  }

  function deleteStudent(id){
    if(!confirm('Delete this student and their tests?')) return;
    const students=getData('students').filter(s=>s.id!==id);
    const tests=getData('tests').filter(t=>t.studentId!==id);
    saveData('students', students);
    saveData('tests', tests);
    renderStudents();
  }

  // ---------- Add Student ----------
  addStudentBtn.onclick = ()=>{
    const id = generateStudentId(); if(id===null) return;
    const first = document.getElementById('firstName').value.trim();
    const last  = document.getElementById('lastName').value.trim();
    const dob   = document.getElementById('dob').value;
    const belt  = document.getElementById('currentBelt').value;
    const instr = instructorSelect.value;
    const loc   = locationSelect.value;
    if(!first||!last||!dob||!belt||!instr||!loc){ alert('Please fill all fields.'); return; }
    const students=getData('students');
    students.push({id, firstName:first, lastName:last, dob, currentBelt:belt, eligible:'✔', instructor:instr, location:loc});
    saveData('students',students);
    document.getElementById('firstName').value='';
    document.getElementById('lastName').value='';
    document.getElementById('dob').value='';
    document.getElementById('currentBelt').value='';
    instructorSelect.value=''; locationSelect.value='';
    renderStudents();
  };

  // ---------- Tests ----------
  function selectedValues(selectEl){
    return Array.from(selectEl.selectedOptions).map(o=>o.value);
  }
  addTestBtn.onclick = ()=>{
    const sid = parseInt(studentTestSelect.value||'0',10);
    const beltFor = beltTestedFor.value;
    const dt = testDate.value;
    const res = testResult.value;
    const instrs = selectedValues(testInstructors);
    const locs = selectedValues(testLocations);
    const cmts = comments.value.trim();

    if(!sid || !beltFor || !dt || !res){ alert('Please fill student, belt, date, and result.'); return; }

    const students=getData('students');
    const s = students.find(x=>x.id===sid);
    if(!s){ alert('Student not found'); return; }

    const tests=getData('tests');
    const newTest={
      id: generateTestId(),
      studentId: sid,
      studentName: `${s.firstName} ${s.lastName}`,
      beltTestedFor: beltFor,
      testDate: dt,
      result: res,
      comments: cmts,
      instructors: instrs,
      locations: locs
    };
    tests.push(newTest);
    if(res==='Pass'){ s.currentBelt=beltFor; saveData('students',students); }
    saveData('tests', tests);

    // Reset form
    studentTestSelect.value='';
    beltTestedFor.value='';
    testDate.value='';
    testResult.value='';
    comments.value='';
    Array.from(testInstructors.options).forEach(o=>o.selected=false);
    Array.from(testLocations.options).forEach(o=>o.selected=false);

    renderStudents();
    renderTests();
  };

  function renderTests(){
    const tests=getData('tests');
    testsTableBody.innerHTML='';
    tests.forEach(t=>{
      const tr=document.createElement('tr');

      const tdStu=document.createElement('td'); tdStu.contentEditable=true; tdStu.textContent=t.studentName;
      const tdBelt=document.createElement('td'); tdBelt.contentEditable=true; tdBelt.textContent=t.beltTestedFor;
      const tdDate=document.createElement('td'); tdDate.contentEditable=true; tdDate.textContent=t.testDate;
      const tdRes=document.createElement('td'); tdRes.contentEditable=true; tdRes.textContent=t.result;
      const tdInstr=document.createElement('td'); tdInstr.contentEditable=true; tdInstr.textContent=(t.instructors||[]).join(', ');
      const tdLoc=document.createElement('td'); tdLoc.contentEditable=true; tdLoc.textContent=(t.locations||[]).join(', ');
      const tdCmt=document.createElement('td'); tdCmt.contentEditable=true; tdCmt.textContent=t.comments||'';

      const tdAct=document.createElement('td');
      const save=document.createElement('button'); save.textContent='Save';
      save.onclick=()=>saveTestInline(t.id, tdStu, tdBelt, tdDate, tdRes, tdInstr, tdLoc, tdCmt);
      const del=document.createElement('button'); del.textContent='Delete'; del.className='danger';
      del.onclick=()=>deleteTest(t.id);
      tdAct.append(save,' ',del);

      tr.append(tdStu, tdBelt, tdDate, tdRes, tdInstr, tdLoc, tdCmt, tdAct);
      testsTableBody.appendChild(tr);
    });
  }

  function saveTestInline(id, tdStu, tdBelt, tdDate, tdRes, tdInstr, tdLoc, tdCmt){
    const tests=getData('tests');
    const idx = tests.findIndex(x=>x.id===id);
    if(idx<0) return;
    tests[idx].studentName = tdStu.textContent.trim();
    tests[idx].beltTestedFor = tdBelt.textContent.trim();
    tests[idx].testDate = tdDate.textContent.trim();
    tests[idx].result = tdRes.textContent.trim();
    tests[idx].instructors = tdInstr.textContent.split(',').map(s=>s.trim()).filter(Boolean);
    tests[idx].locations = tdLoc.textContent.split(',').map(s=>s.trim()).filter(Boolean);
    tests[idx].comments = tdCmt.textContent.trim();
    saveData('tests', tests);
    renderTests();
  }

  function deleteTest(id){
    if(!confirm('Delete this test record?')) return;
    const tests=getData('tests').filter(t=>t.id!==id);
    saveData('tests', tests);
    renderTests();
  }

  // ---------- Export / Print / Reset ----------
  function exportCSV(filename, rows){
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
  }
  exportStudentsBtn.onclick = ()=>{
    const s=getData('students');
    const rows=[['ID','First Name','Last Name','DOB','Belt','Eligible','Instructor','Location']];
    s.forEach(x=>rows.push([x.id,x.firstName,x.lastName,x.dob,x.currentBelt,x.eligible||'',x.instructor||'',x.location||'']));
    exportCSV('students.csv', rows);
  };
  exportTestsBtn.onclick = ()=>{
    const t=getData('tests');
    const rows=[['Student','Belt Tested For','Date','Result','Instructors','Locations','Comments']];
    t.forEach(x=>rows.push([x.studentName,x.beltTestedFor,x.testDate,x.result,(x.instructors||[]).join('; '),(x.locations||[]).join('; '),x.comments||'']));
    exportCSV('tests.csv', rows);
  };
  function printSection(el){
    const w=window.open('','Print','width=900,height=700');
    w.document.write('<html><head><title>Print</title></head><body class="printable">'+el.outerHTML+'</body></html>');
    w.document.close(); w.focus(); w.print(); w.close();
  }
  printStudentsBtn.onclick = ()=> printSection(document.getElementById('studentsCard'));
  printTestsBtn.onclick   = ()=> printSection(document.getElementById('testsCard'));

  resetDemoBtn.onclick = ()=>{
    if(!confirm('Reset demo data? This will erase all current data.')) return;
    localStorage.removeItem('students');
    localStorage.removeItem('tests');
    // keep instructors/locations so your custom lists persist; comment the next two lines if you want to wipe them too:
    // localStorage.removeItem('instructors');
    // localStorage.removeItem('locations');
    location.reload();
  };

  // ---------- Search ----------
  searchInput.addEventListener('input', renderStudents);

  // ---------- Init ----------
  function init(){
    renderInstructorSelects();
    renderLocationSelects();
    renderInstructorsModal();
    renderLocationsModal();
    renderStudents();
    renderDashboard();
  }
  init();
</script>
</body>
</html>
